---
title: "Appendix A - Alternative DSDM formulations"
author:
  - Nick Golding
  - School of BioSciences, University of Melbourne, Parkville VIC, Australia
bibliography: dsdm.bib
csl: mee.csl
output:
  pdf_document:
    toc: true
    toc_depth: 3
  word_document:
    fig_caption: true
    highlight: null
---

\newcommand{\smallunderscore}{\textscale{.5}{\textunderscore}}

```{r knitrOpts, echo = FALSE, cache = FALSE, eval = TRUE}
# set up knitr options
knitr::opts_chunk$set(message = FALSE,
               warning = FALSE,
               eval = FALSE,
               cache = FALSE)
```

# Introduction

This appendix provides statistical notation and computer code for the R packages greta and greta.dynamics [@goldingGretaDynamicsModelling2019; @goldingGretaSimpleScalable2019] to implement the broad range of DSDMs proposed in the manuscript *Demographic Species Distribution Models* by Nick Golding.

Each section below details a modelling option for a specific component of the DSDM: the observation model, abundance model, or population dynamic model. These components are largely inter-operable; a user can pick one modelling option from each category that best fits the ecology of the species of interest and the ecological question at hand. The one exception to this is that abundance models using as input the intrinsic growth rate of the species (the Beverton-Holt model in the manuscript example, and the Ricker model introduced here) cannot be used in combination with the population dynamic models that have either dynamic transition matrices or dispersal, since those population dynamic models do not yield a separate intrinsic growth rate for each site. With those models, the relative abundance is instead calculated directly from the dynamics, so these abundance models are not needed.

This appendix only considers the structures of the proposed models, specification of priors for parameters in the models are not discussed here. See [@goldingGretaSimpleScalable2019] and the website [greta-stats.org](https://greta-stats.org) for general guidance on how to build models with greta. I reiterate here that the aim of DSDMs is to incorporate ecological knowledge via informative priors, and the parameters of the proposed models are unlikely to be identified with uninformative priors.

Note that statistical notation is written in the standard way with the first line giving the sampling distribution, and subsequent lines defining the variables on which previous lines depend, however the code uses the reverse order since in greta variables must be defined before they can be used to create other variables.


# Basic DSDM

For ease of reference I repeat here the notation, and add the code, for the basic presence-absence DSDM presented in the main manuscript. The model is composed of three of the components detailed below: a static two-stage transition matrix model of population dynamics, a Beverton-Holt model of abundance, and a presence-absence observation model.

##### Notation

\begin{align}
y_i &\sim Bernoulli(p_i) \\ \nonumber
p_i &= 1 - e^{-\Lambda_i} \\ \nonumber
\Lambda_i &= ln(1 + e^{K_i})  \\ \nonumber
K_i &= (\lambda_i - 1) \alpha \\ \nonumber
\lambda_i &= eigval(\mathbf{A}_i) \\ \nonumber
\mathbf{A}_i &= \begin{bmatrix} F_i \cdot S_{J_i} & F_i \cdot S_{A_i} \\ S_{J_i} & S_{A_i}  \end{bmatrix} \\ \nonumber
ln(F_i) &= \mathbf{X}_i\beta_F \\ \nonumber
logit(S_{A_i}) &= \mathbf{X}_i\beta_S \\ \nonumber
logit(S_{J_i}) &= logit(S_{A_i}) - \gamma
\end{align}

where $y$ is a vector of length $N$ giving the presence or absence of the species at site $i$, $eigval(\mathbf{A}_i)$ denoted the dominant eigenvalue of the population transition matrix at site $i$; the intrinsic growth rate of that population, $\mathbf{X}$ a $N$x$K$ design matrix of the values of environmental covariates at each site, an intercept (coded as a column of all ones), and any transformations of those covariates, $\beta_F$ and $\beta_S$ are parameter vectors of length $K$ giving regression coefficients for the log-fecundity and logit-survival submodels respectively, $\gamma$ is a positive scalar parameter for the logit-difference between adult and juvenile survival, and $\alpha$ is a positive scalar parameter for the combined effects of imperfect detection and the relationship between the intrisic growth rate and abundance in the Beverton-Holt model.

**$K$ is used both for site carrying capacity and number of covariates?**

##### Code

Input:

- `X`: a $N$x$K$ design matrix for vital rate regression sub-models
- `beta_F`: a vector of length $K$ of regression coefficients for log-fecundity
- `beta_s`: a vector of length $K$ of regression coefficients for logit-survival
- `gamma`: a (positive) scalar for the difference in logit-survival between adults and juveniles
- `alpha`: a (positive) scalar for the combined effect of imperfect detection and density dependence
- `y`: a vector of 1s and 0s encoding presence-absence observations

```{r basic_dsdm}
log_F <- X %*% beta_F
logit_S_A <- X %*% beta_S
F <- exp(log_F)
S_A <- ilogit(logit_S_A)
S_J <- ilogit(logit_S_A - gamma)
top <- cbind(F * S_J, F * S_A)
bottom <- cbind(S_J, S_A)
A <- abind(top, bottom, along = 3)

analysis <- iterate_matrix(A)
lambda <- analysis$lambda
K <- (lambda - 1) * alpha
Lambda <- log1pe(K)

p <- 1 - exp(-Lambda)
distribution(y) <- bernoulli(p)
```


# Observation models

Below I provide alternative observation models for presence-absence, count, and presence-only species distribution data, linking their parameters to the variable $\Lambda_i$ representing relative abundance at site $i$. These observation models can also be extended to distribution data that are disaggregated by time, stage, species, or genotype by iterating over the appropriate index. A wider range of observation models for distribution data &mdash; such as that for disentangling occupancy and detection &mdash; can be implemented using other greta extension packages, but are beyond the scope of this manuscript. Similarly, observation models for demographic data (e.g. for an integrated population modelling approach) could be included, but are not considered here, since the focus of this paper is the types of data typically used for statistical modelling of species distributions.

## Presence-absence data

Presence-absence data $y_i$ are assumed to be independently Bernoulli-distributed following a probability of presence $p_i$, as in a standard presence-absence species distribution model. This probability of presence can be calculated from the relative abundance by considering the presence-absence data as arising from a truncation of count data: the species recorded as present if one or more individuals were detected, or otherwise a absent. By assuming that counts follow a Poisson distribution with expected value $\Lambda_i$, the probability of species presence (a count greater than 0) is given by $1-e^{-\Lambda_i}$. This is equivalent to the likelihood of a GLM for binary data with complementary log-log link function and linear predictor $ln(\Lambda_i)$.

##### Notation

\begin{align}
y_i &\sim Bernoulli(p_i) \\ \nonumber
p_i &= 1 - e^{-\Lambda_i}
\end{align}

##### Code

Input:

- `y`: a vector of 1s and 0s encoding presence-absence observations
- `Lambda`: a (positive) vector of the relative abundances for each observation

```{r basic_obs}
p <- 1 - exp(-Lambda)
distribution(y) <- bernoulli(p)
```

## Poisson count data

The relative abundance variable $\Lambda_i$ is the parameter of the Poisson distribution, so a Poisson count model is simply given by:

##### Notation

\begin{align}
y_i &\sim Poisson(\Lambda_i)
\end{align}

##### Code

Input:

- `y`: a vector of non-negative integers encoding count observations
- `Lambda`: a (positive) vector of the relative abundances for each observation

```{r poisson_obs}
distribution(y) <- poisson(Lambda)
```

## Negative binomial count data

Where count data are over-dispersed with respect to the expected counts $\Lambda_i$, this over-dispersion can be modelled with a negative binomial distribution as:

##### Notation

\begin{align}
p_i &= r / (r + \Lambda_i) \\ \nonumber
y_i &\sim Negative Binomial(r, p_i)
\end{align}

Where the negative binomial is parameterised in terms of dispersion parameter $r$ representing the target number of successful trials, and $p_i$ the probability of success in each trial.

##### Code

Input:

- `r`: a (positive) scalar giving the dispersion parameter of the negative binomial distribution (equivalent to the `size` argument of `stats::dnbinom()`)
- `Lambda`: a (positive) vector of the relative abundances for each observation
- `y`: a vector of (non-negative) integers encoding count observations

```{r negbin_obs}
p <- r / (r + Lambda)
distribution(y) <- negative_binomial(r, p)
```


## Presence-only data

Presence-only data &mdash; where records consist of locations where the species has been reported as being present &mdash; can be considered as a thinned, inhomogeneous Poisson point process [@wartonPoissonPointProcess2010;@rennerPointProcessModels2015]. The likelihood for this model comprises an intractable integral over the study area, which can be approximated in a number of ways that reduce the model to having a Poisson observation model. Here I apply the piece-wise constant approximation, defining the observations $y_i$ to be counts of occurrence records in each cell $i$, having area $a_i$, where the cells represent a partition of the study area [@diggleSpatialSpatioTemporalLogGaussian2013;@simpsonGoingGridComputationally2011]. That is they tessellate (but do not overlap) and together cover the entire study area.
Under this definition, the DSDM relative abundance parameter $\Lambda_i$ represents a density of point observations per unit area (assumed to be homogeneous across cell $i$) that *would* be seen if there were no spatial bias in rates of reporting. The expected number of presence-only observations in each cell is therefore the product of the relative abundance $\Lambda_i$, the area $a_i$, and a relative measure of the bias in reporting, $\tau_i$ (also assumed homogeneous across each cell). Values of $\tau_i$ for each location can be provided as data, or estimated during model-fitting via an additional regression sub-model against detection covariates. Since $\Lambda_i$ is only identified to within a multiplicative constant ($\alpha$ in Equation 2), the absolute value of $\tau_i$ is not identified in this model, so any model for $\tau_i$ should probably not have an intercept term. 


##### Notation

\begin{align}
y_i &\sim Poisson(a_i\tau_i\Lambda_i)
\end{align}

##### Code

Input:

- `y`: a vector of (non-negative) integers encoding the number of occurrences in each cell 
- `a`: a vector giving the areas of each cell
- `tau`: a (positive) vector of the relative reporting rates in each cell
- `Lambda`: a (positive) vector of the relative abundances  in each cell

```{r ppm_obs}
distribution(y) <- poisson(a * tau * Lambda)
```

## Integrated models

Specification of integrated models (those with multiple likelihoods for different datatypes) is straightforward. For example, a combined observation  presence-absence and abundance model might be defined as:

\begin{align}
y_i &\sim \begin{cases}
Bernoulli(p_i), & \text{if } z_i = 1 \\ \nonumber
Poisson(\alpha^* \Lambda_i) , & \text{otherwise}
\end{cases} \\ \nonumber
p_i &= 1 - e^{-\Lambda_i}
\end{align}

where $z_i$ is an indicator variable for whether the observation $y_i$ represents presence-absence or count data, and $\alpha^*$ is a detection rate parameter &mdash; in addition to the $\alpha$ used to define $\Lambda_i$ &mdash; giving the detectability of individuals in the surveys yielding the count data, relative to that in the surveys yielding the presence-absence data.

##### Code

Input:

- `Lambda`: a vector of (positive) relative abundances for all sites, for both presence-absence and count data.
- `y_pa`: a vector of 1s and 0s encoding presence-absence observations
- `y_count`: a vector of (non-negative integers) encoding count observations
- `pa_locations`: a vector of (positive) integers with the same length as `y_pa` giving the site numbers corresponding to presence-absence data
- `count_locations`: a vector of (positive) integers with the same length as `y_count` giving the site numbers corresponding to count data
- `alpha_star`: a (positive) scalar giving the detection rate for the count data, relative to the detection rate of the presence-absence data.

```{r integrated_obs}
p <- 1 - exp(-Lambda[pa_locations])
distribution(y_pa) <- bernoulli(p)
distribution(y_count) <- poisson(alpha_star * Lambda[count_locations])
```

# Abundance models

This section introduces a number of options for deriving a site-specific relative abundance from the transition matrix representing population dynamics. These can be broadly split into two groups - those computed from a temporally-static population transition matrix and those from a dynamic transition matrix. 

## Static transition matrices

Static population transition matrices are the typical form of matrix population models, following the definition of population dynamics over a stage-structured population size vector $\mathbf{n}_{i,t}$ at site $i$:

\begin{align}
\mathbf{n}_{i,t+1} &= \mathbf{A}_{i} \mathbf{n}_{i,t}
\end{align}

The population transition matrix $\mathbf{A}_i$ at each site is constant between iteration times $t$. Because $\mathbf{A}_i$ is constant, it can be analysed to compute an intrinsic growth rate and stable stage distribution, without having to explicitly consider population sizes $\mathbf{n}_{i,t}$. This growth rate and/or stable stage distribution can then be related to a relative abundance $\Lambda_i$ under some assumptions. This is the approach used in the DSDM examples in the manuscript.

### Beverton-Holt model

The Beverton-Holt model of population dynamics for single (not stage-structured) population $n_{i}$ is:

\begin{align}
n_{i,t+1} &= \frac{\lambda_i n_{i,t}}{1 + n_{i,t} / M}
\end{align}

where $\lambda_i$ is the intrinsic growth rate of the population (which can be calculated as the dominant eigenvalue of $\mathbf{A}_i$), and $M$ is a scaling factor implicitly representing density-dependent effects. The carrying capacity of the Beverton-Holt model is given by $(\lambda_i - 1) M$, which we assume to be be proportional to the relative abundance that we can observee via species distribution data (assuming the population is at equilibrium), with the constant of proportionality being a per-individual detection rate; the fraction of individuals in the population detected in the survey from which we obtained our distribution data. This detection rate is not identified from the density-dependence parameter $M$, so we replace their product with the parameter $\alpha$ to yield the theoretical relative carrying capacty parameter $K_i = (\lambda_i - 1) \alpha$. An unfortunate consequence of this simple relationship is that $K_i$ is negative when $\lambda_i < 1$, and thus not a valid population size. It is therfore rectified (forced to be positive) by the softplus function to give the relative abundance $\Lambda_i = ln(1 + e^{K_i})$, so that $\Lambda_i$ is close to zero when $\lambda_i < 1$, and approximately equal to $K_i$ when $\lambda_i > 1$. 

##### Notation

\begin{align}
\Lambda_i &= ln(1 + e^{K_i})  \\ \nonumber
K_i &= (\lambda_i - 1) \alpha \\ \nonumber
\lambda_i &= eigval(\mathbf{A}_i)
\end{align}

##### Code

Input:

- `A`: an $N$x$M$x$M$ array containing the $M$x$M$ transition matrices for all sites
- `alpha`: a (positive) scalar for the combined effect of imperfect detection and density dependence

**BP: Here and Ricker: should A be an NxK matrix, as in first section, above?; Further below, M seems to now be used for number of stages rather than densitiy dependence parameter**

```{r beverton_holt}
analysis <- iterate_matrix(A)
lambda <- analysis$lambda
K <- (lambda - 1) * alpha
Lambda <- log1pe(K)
```

### Ricker model

An alternative population dynamic model with which to relate the intrinsic growth rate to relative abundance is the Ricker model, which for single (not stage-structured) population $n_{i}$ is:

\begin{align}
n_{i,t+1} &= n_{i,t} e^{\lambda_i - n_{i,t} / M}
\end{align}

where $M$ again denotes a density-dependence parameter relating the intrinsic growth rate to the carrying capacity via a linear function $K_i = \lambda_i M$. With positive $M$, $K_i$ does not need rectifying to yield the relative abundance. As with the Beverton-Holt model, we define a parameter $\alpha$ which combines the density-dependence and reporting rate, giving us $\Lambda_i = \lambda_i \alpha$. This relationship us used in the dynamic range model of @pagelForecastingSpeciesRanges2012. Whilst it has the advantage of not requiring rectification of the carrying capacity, it has the disadvantage that with large enough $\alpha$, this approach can yield large values of $\Lambda_i$ even if $\lambda_i$ is well below 1, in which case the species should not be able to persist at this site.

##### Notation

\begin{align}
\Lambda_i &= \lambda_i \alpha \\ \nonumber
\lambda_i &= eigval(\mathbf{A}_i)
\end{align}

##### Code

Input:

- `A`: an $N$x$M$x$M$ array containing the $M$x$M$ transition matrices for all sites
- `alpha`: a (positive) scalar for the combined effect of imperfect detection and density dependence

```{r ricker_abundance}
analysis <- iterate_matrix(A)
lambda <- analysis$lambda
Lambda <- lambda * alpha
```


### Stage-structured abundances

Where distribution data are disaggregated according to discrete stages considered in the population transition matrix, the corresponded relative abundance $\Lambda_{j,i}$ for each stage $j$ can be calculated by computing the overall relative abundance $\Lambda^*_{j,i}$ via one of the two models above, and then disaggregating it into the $M$ stages using the stable stage distribution vector $\mathbf{v}_i$: the dominant (left) eigenvector $\mathbf{v}^*_i$ normalised to sum to 1.

An approach similar to this can also used be used to compute relative abundances from a static transition matrix for a  matrix metapopulation model: in that model the stable distribution between sites already provides a relative abundance estimate, so there is no need for a model to relate the intrinsic growth rate to relative abundance. See [*Dispersal with a static transition matrix*](#static_dispersal) for details.

##### Notation

This notation uses the Beverton-Holt abundance model to compute the overall relative abundance parameter $\Lambda^*_i$, but the Ricker model could be used instead.

\begin{align}
\Lambda_{j,i} &= \Lambda^*_i \mathbf{v}_{j,i} \\ \nonumber
\mathbf{v}_{j,i} &= \mathbf{v}^*_{j,i} / \textstyle\sum_{j=1}^{M}{\mathbf{v}^*_{j,i}} \\ \nonumber
\mathbf{v}^*_i &= eigvec(\mathbf{A}_i) \\ \nonumber
\Lambda^*_i &= ln(1 + e^{K_i})  \\ \nonumber
K_i &= (\lambda_i - 1) \alpha \\ \nonumber
\lambda_i &= eigval(\mathbf{A}_i)
\end{align}

where $eigvec(\mathbf{A}_i)$ gives the dominant left eigenvector of the population transition matrix $\mathbf{A}_i$.

##### Code

- `A`: a 3D $N$x$M$x$M$ array giving the population transition matrix at each site
- `alpha`: a (positive) scalar for the combined effect of imperfect detection and density dependence

```{r stage_structured}
analysis <- iterate_matrix(A)
lambda <- analysis$lambda
v <- analysis$stable_abundance_distribution
K <- (lambda - 1) * alpha
Lambda_star <- log1pe(K)
Lambda <- Lambda_star * v
```


## Dynamic transition matrices

Analysis of matrix population models with static transition matrices assumes both that the population is at equilibrium, and that the dynamics can be adequately by an intrinsic growth rate and stable stage distribution. Where those assumptions are incompatible with the study system, data or questions being being asked, an alternative is to specify the matrix population model with a dynamic transition matrix $\mathbf{A}_{i,t}$, which differs between times $t$:

\begin{align}
\mathbf{n}_{i,t+1} &= \mathbf{A}_{i,t} \mathbf{n}_{i,t}
\end{align}

In this model the population transition matrix is recomputed at each iteration $t$, and can change between time points depending on fluctutating environmental conditions or the species' population density. Because the dynamic transition matrix is constantly changing, the dynamics cannot be represented by an intrinsic growth rate or stable stage distribution. Instead, iteration of the matrix explicitly considers population sizes. A separate model relating the transition matrix to a carrying capacity is no longer needed, since the vector of $\mathbf{n}_{i,t}$ of population sizes can be directly converted into a relative abundance.

Matrix models with static population transition matrices implicitly assume density-independent growth (or decline) of population sizes. In the static models above, density dependence is introduced by the abundance model. This is problematic when explicitly considering the population sizes $\mathbf{n}_{i,t}$, since all populations will tend to either infinity or zero as $t$ increases. When considering a dynamic transition matrix it is therefore necessary to consider negative density-dependence in calculation of $\mathbf{A}_{i,t}$, so that the simulated dynamics are not explosive.

### Density-dependent vital rates - equilibrium solution

In static transition models considered above, carrying capacity is modelled as some function of the intrinsic growth rate; a relationship which implicitly represents density dependence. Rather than considering that density dependence is a function of the growth rate, it may be more ecologically realistic to explicitly model the vital rates as being density-dependent: that is, having the survival probabilities or fecundity rates at a given time point depend on the population density at the previous time point. This enables incorporation of more detailed ecological knowledge about how vital rates drive abundance, which may be important to consider if the answer to the ecological question of interest depends on density dependence.

Density dependent vital rates can be incorporated in a DSDM by constructing the dynamic population transition matrix $\mathbf{A}_{i,t}$, from dynamic vital rates that are computed as a function of both the environment and the total population (i.e. across all life stages $M$) in the previous time point. For example, these density-dependent relationships could be a linear function of population density, controlled by parameters $\alpha_F$ and $\alpha_S$ on the link-scale of the vital rates. Where $\alpha_F$ and $\alpha_S$ are negative, density-dependence will lead to self-regulating populations that will ultimately converge on a finite carrying capacity.

Starting with an initial population size vector $\mathbf{n}_{i,0}$, the dynamics can be iterated $T$ times to solve the for the population size at that time $\mathbf{n}_{i,T}$. With self-regulating density-dependence (negative feedback), as $T$ increases $\mathbf{n}_{i,T}$ will approach a stable population size. If $T$ is selected to be sufficiently large that population sizes have stopped changing between iterations (to within some numerical tolerance), $\mathbf{n}_{i,T}$ can be interpreted as the equilibrium relative abundance. As in the static transition matrix models, the parameters $\alpha_F$ and $\alpha_S$ control both the strength of density-dependence and the detection rate, since these parameters are not identified separately.

##### Notation

\begin{align}
\Lambda_i &=  \mathbf{n}_{i, T} \\ \nonumber
\mathbf{n}_{i,t+1} &= \mathbf{A}_{i,t} \mathbf{n}_{i,t} \\ \nonumber
\mathbf{A}_{i,t} &= \begin{bmatrix} F_{i,t} \cdot S_{J_{i,t}} & F_{i,t} \cdot S_{A_{i,t}} \\ S_{J_{i,t}} & S_{A_{i,t}}  \end{bmatrix}  \\ \nonumber
ln(F_{i,t}) &= \mathbf{X}_i \beta_F + \alpha_F \textstyle\sum_{j=1}^M{\mathbf{n}_{i,j,t}}\\ \nonumber
logit(S_{A_{i,t}}) &= \mathbf{X}_i \beta_S + \alpha_S \textstyle\sum_{j=1}^M{\mathbf{n}_{i,j,t}} \\ \nonumber
logit(S_{J_{i,t}}) &= logit(S_{A_{i,t}}) - \gamma
\end{align}
where $\alpha_F$ and $\alpha_S$ are negative scalar parameters controlling the strength of density dependence and the detection rate, and $T$ is positive integer giving a number of iterations chosen such that the population sizes have converged to within a tolerance, i.e. $|\mathbf{n}_{i,T} - \mathbf{n}_{i,T-1}| / \mathbf{n}_{i,T-1} < \epsilon$ for some small positive tolerance $\epsilon$. This criterion means that the value of the initial population sizes $\mathbf{n}_{i,0}$ do not impact upon the model. 

##### Code

Input:

- `X`: a $N$x$K$ design matrix for vital rate regression sub-models
- `beta_F`: a vector of length $K$ of regression coefficients for log-fecundity
- `beta_s`: a vector of length $K$ of regression coefficients for logit-survival
- `alpha_F`: a scalar for the effect of population density on log-fecundity
- `alpha_S`: a scalar for the effect of population density on logit-survival
- `gamma`: a (positive) scalar for the difference in logit-survival between adults and juveniles

```{r vital_dd_abundance}
A_t_function <- function(state, iter, log_F, logit_S, alpha_F, alpha_S, gamma) {
  
  N <- rowSums(state)
  log_F_t <- base_log_F +  alpha_F * N
  logit_S_A_t <- base_logit_S + alpha_S * N
  
  F_t <- exp(log_F_t)
  S_A_t <- ilogit(logit_S_A_t)
  S_J_t <- ilogit(logit_S_A_t - gamma)

  top <- cbind(F_t * S_J_t, F_t * S_A_t)
  bottom <- cbind(S_J_t, S_A_t)
  A_t <- abind(top, bottom, along = 3)
  A_t
  
}

iterations <- iterate_dynamic_matrix(
  matrix_function = A_t_function, 
  base_log_F = X %*% beta_F,
  base_logit_S = X %*% beta_S,
  alpha_F = alpha_F,
  alpha_S = alpha_S,
  gamma = gamma
)

Lambda <- iterations$stable_population
```

### Density-dependent vital rates - non-equilibrium solution

Where the data or questions of the analysis are such that equilibrium population sizes are not representative of the population, the density-dependent vital rate model above can be iterated for predetermined number of timepoints $T$, such that each time $t$ corresponds to an observed time in the distribution data. For example, where the impacts of short-term variation in environmental conditions (environmental stochasticity) on population sizes is important, the transition matrix $\mathbf{A}_{i,t}$ at each time can be computed as a function of the design matrix of observed environmental conditions $\mathbf{X}_t$ at that time, and the current population density. The resulting population size $\mathbf{n}_{i,t}$ at each time $t$ can then be used in an observation model for the observed distribution data at that time $y_{i,t}$.

Under this formulation, the population size parameters $\mathbf{n}_{i,t}$ will be affected by the initial population state $\mathbf{n}_{i,0}$. This can either be introduced as an unknown parameter in the model, or set to an arbitrary value but with the considered time period set so that there is a sufficiently long 'burn-in' period prior to the first observation that its value has little effect on the estimated model parameters.

##### Notation

\begin{align}
y_{i,t} &\sim Bernoulli(p_{i,t}) \\ \nonumber
p_{i,t} &= 1 - e^{-\Lambda_{i,t}} \\ \nonumber
\Lambda_{i,t} &=  \mathbf{n}_{i,t} \\ \nonumber
\mathbf{n}_{i,t+1} &= \mathbf{A}_{i,t} \mathbf{n}_{i,t} \\ \nonumber
\mathbf{A}_{i,t} &= \begin{bmatrix} F_{i,t} \cdot S_{J_{i,t}} & F_{i,t} \cdot S_{A_{i,t}} \\ S_{J_{i,t}} & S_{A_{i,t}}  \end{bmatrix}  \\ \nonumber
ln(F_{i,t}) &= \mathbf{X}_{i,t} \beta_F + \alpha_F \textstyle\sum_{j=1}^M{\mathbf{n}_{i,j,t}}\\ \nonumber
logit(S_{A_{i,t}}) &= \mathbf{X}_{i,t} \beta_S + \alpha_S \textstyle\sum_{j=1}^M{\mathbf{n}_{i,j,t}} \\ \nonumber
logit(S_{J_{i,t}}) &= logit(S_{A_{i,t}}) - \gamma
\end{align}

Note that this notation is very similar to the density-dependent vital rate model, except that both the observation model (the first three lines) and the design matrix $\mathbf{X}$ are temporally-indexed, and the relative abundances $\Lambda_{i,t}$ are given by the contemporary population sizes, not the terminal sizes.

##### Code

Input:

- `X_list`: a list of length $T$ of $N$x$K$ design matrices for each of the time points
- `n_init`: a (positive) vector of length $M$ or matrix of dimension $N$x$M$ giving the initial population state at each location
- `timesteps`: the value of $T$.
- `beta_F`: a vector of length $K$ of regression coefficients for log-fecundity
- `beta_s`: a vector of length $K$ of regression coefficients for logit-survival
- `alpha_F`: a scalar for the effect of population density on log-fecundity
- `alpha_S`: a scalar for the effect of population density on logit-survival
- `gamma`: a (positive) scalar for the difference in logit-survival between adults and juveniles
- `y`: an $N$x$T$ matrix of presence-absence data at each time-step and site

```{r short_term_temporal}
A_t_function <- function(state, iter, X, beta_F, beta_S, alpha_F, alpha_S, gamma) {
  
  N <- rowSums(state)
  log_F_t <- X %*% beta_F +  alpha_F * N
  logit_S_A_t <- X %*% beta_S + alpha_S * N
  
  F_t <- exp(log_F_t)
  S_A_t <- ilogit(logit_S_A_t)
  S_J_t <- ilogit(logit_S_A_t - gamma)

  top <- cbind(F_t * S_J_t, F_t * S_A_t)
  bottom <- cbind(S_J_t, S_A_t)
  A_t <- abind(top, bottom, along = 3)
  A_t
  
}

iterations <- iterate_dynamic_matrix(
  matrix_function = A_t_function, 
  initial_state = n_init,
  niter = timesteps,
  X = X_list,
  beta_F = beta_F,
  beta_S = beta_S,
  alpha_F = alpha_F,
  alpha_S = alpha_S,
  gamma = gamma
)

Lambda <- iterations$all_states
p <- 1 - exp(-Lambda)
distribution(y) <- bernoulli(p)
```


# Population dynamic models

## Basic matrix population model

The two-stage static matrix population model considered in the manuscript represents the simplest form of DSDM.  The transition matrix $\mathbf{A}_i$ describes the fundamental dynamics of the population at location $i$, with cells expressing the rates of transition from each stage at the previous time step (columns) to each stage in the present time step (rows). Thus for each adult in the previous time step $F_i \cdot S_{A_i}$ juveniles are contributed to the population in the current time step: each adult survives with probability $S_{A_i}$, and produces an average of $F_i$ offspring, with the product of these giving the expected contribution per adult. For more details of matrix population models such as this, see [@caswellMatrixPopulationModels2001], or any number of papers in the matrix population modelling literature.

Each of these vital rates at each site $i$ is given by a linear model against a design matrix $\mathbf{X}_i$ representing environmental covariates, an intercept (coded as a column of all ones), and any transformations of those covariates

##### Notation

\begin{align}
\mathbf{A}_i &= \begin{bmatrix} F_i \cdot S_{J_i} & F_i \cdot S_{A_i} \\ S_{J_i} & S_{A_i}  \end{bmatrix} \\ \nonumber
ln(F_i) &= \mathbf{X}_i\beta_F \\ \nonumber
logit(S_{A_i}) &= \mathbf{X}_i\beta_S \\ \nonumber
logit(S_{J_i}) &= logit(S_{A_i}) - \gamma
\end{align}

##### Code

Input:

- `X`: a $N$x$K$ design matrix for vital rate regression sub-models
- `beta_F`: a vector of length $K$ of regression coefficients for log-fecundity
- `beta_s`: a vector of length $K$ of regression coefficients for logit-survival
- `gamma`: a (positive) scalar for the difference in logit-survival between adults and juveniles

```{r basic_transition}
log_F <- X %*% beta_F
logit_S_A <- X %*% beta_S
F <- exp(log_F)
S_A <- ilogit(logit_S_A)
S_J <- ilogit(logit_S_A - gamma)

top <- cbind(F * S_J, F * S_A)
bottom <- cbind(S_J, S_A)
A <- abind(top, bottom, along = 3)
```

## Dispersal with a static transition matrix {#static_dispersal}

Dispersal of individuals between sites can be incorporated into a static transition matrix by expanding the matrix population model to a spatially-structured matrix that simultaneously considers populations in all patches, with dispersal between patches quantified by a dispersal kernel.

In previous models, which assumed sites to be independent of one another with respect to their population dynamics, the 3D $N$x$M$x$M$ array $A$ contained the $M$x$M$ transition matrices $\mathbf{A}_i$ for each of the $N$ sites $i$. To consider interacting population dynamics across sites, we can instead consider a single, larger transition matrix $\mathbf{A}^*$ with dimension $NM$x$NM$. This matrix combines two $NM$x$NM$ block-diagonal matrices: $\mathbb{A}$ - with each of the $N$ diagonal blocks giving the $M$x$M$ population transition matrix at site $i$ $\mathbf{A}_i$; and $\mathbb{D}$ - with each of the $M$ diagonal blocks giving an $N$x$N$ between-site dispersal matrix $\mathbf{D}_j$ for stage $j$. $\mathbf{A}^*$ is formed as $\mathbf{A}^* = \mathbf{P}^T \mathbb{D}\mathbf{P} \mathbb{A}$, where $\mathbf{P}$ is the vec-permutation matrix described in @hunterUseVecpermutationMatrix2005, which composes the two component matrices in the appropriate way. Note that this formulation assumes that in each season demographic transitions occur, then dispersal. For the reverse order, the matrix would be computed as $\mathbf{A}^* = \mathbf{P} \mathbb{A} \mathbf{P}^T \mathbb{D}$.

Each element of the stage-dispersal matrices $\mathbf{D}_j$ give the probability $D_{j,i',i}$ that an individual of  stage $j$ in site $i$ will move to site $i'$ in this time-step. $D_{j,i',i}$ is computed using a dispersal kernel (an exponential kernel in this example) with stage-specific dispersal ability parameter $\tau_j$, standardised to sum to 1 over the study area to ensure $D_{j,i',i}$ is a valid probability.

By connecting the populations at all sites with immigration and emigration potential, we now have a single intrinsic growth rate for the entire population rather than for the population at each site. Rather than computing the relative abundance at each site $\Lambda_i$ as a function of an intrinsic growth rate, we can instead sum stable stage distributions over the stages in each site to yield a stable population distribution over sites. $\Lambda_i$ can therefore be computed as proportional (with constant $\alpha$) to this relative population size.

In practice, the matrix $\mathbf{A}^*$ can be very sparse: the proportion of non-zero elements is $(M + N - 1) / (MN)$; as N increases, the proportion of non-zero approaches $1/M$. This sparsity can be increased further by setting an upper dispersal limit, beyond which $d_{j,i',i}$ is set to zero, or by limiting the number of stages that can disperse. It is therefore computationally advantageous to compute the dominant eigenvector using sparse matrix methods, e.g. by iteration using sparse matrix multiplication, as in the biotic interaction model.

#### Notation

\begin{align}
\Lambda_i &= \alpha \mathbf{v}_i / \textstyle\sum_{i=1}^{N}{\mathbf{v}_{i}} \\ \nonumber
\mathbf{v}_i &= \textstyle\sum_{j=1}^{M}{\mathbf{v}^*_{j+(i-1)}} \\ \nonumber
\mathbf{v}^* &= eigvec(\mathbf{A}^*) \\ \nonumber
\mathbf{A}^* &= \mathbf{P} \mathbb{A} \mathbf{P}^T \mathbb{D} \\ \nonumber
\mathbb{A} = \begin{bmatrix} \mathbf{A}_1 & & \dots & & 0 \\
& \ddots & & & \\
\vdots & & \mathbf{A}_i & & \vdots \\
& & & \ddots & \\
0 & & \dots & & \mathbf{A}_N \end{bmatrix}
&\,\, \mathbb{D} = \begin{bmatrix} \mathbf{D}_1 & & \dots & & 0 \\
& \ddots & & & \\
\vdots & & \mathbf{D}_j & & \vdots \\
& & & \ddots & \\
0 & & \dots & & \mathbf{D}_M \end{bmatrix} \\ \nonumber
\mathbf{D}_{j,i',i} &= d_{j,i',i} / \textstyle\sum_{i'=1}^Nd_{j,i',i} \\ \nonumber
d_{j,i',i} &=  e^{-\tau_j D_{i',i}}
\end{align}
where $D$ is an $N$x$N$  dense, symmetric matrix of Euclidean distances between all sites.

##### Code

Input:

- `A`: a 3D $N$x$M$x$M$ array giving the population transition matrix at each site
- `distance_matrix`: a (possibly sparse) $N$x$N$ matrix of distances between sites
- `tau`: a vector of length $M$ of (positive) dispersal ability parameters for each stage
- `alpha`: a (positive) scalar for the combined effect of imperfect detection and density dependence

```{r static_dispersal}
dispersal_kernel <- function (distance) {
  exp(-tau * distance)
}

analysis <- iterate_matrix(
  matrix = A,
  distances = distance_matrix,
  dispersal_kernel = dispersal_kernel
)

Lambda <- alpha * analysis$stable_abundance_distribution
```

## Dispersal with dynamic transition matrix

Where the transition matrix is assumed to be dynamic - i.e.. to model the effects of environmental stochasticity, density-dependent vital rates, or population time series - we can use the same model structure as for a static transition matrix, but combine it with the iterative approach used for dynamic transition matrix models above. Because the matrix is explicitly iterated dispersal can be incorporated with a second matrix multiplication rather than needing to combine the population transition and dispersal matrices into a single block matrix. As for other dynamic transition matrix models, density-dependent vital rates are required to compute the relative abundances, since neither an intrinsic growth rate nor a stable population distribution are available in the dynamic matrix model.

In the notation below, I introduce an intermediate $N$x$M$ population state matrix $\mathbf{n}^*_{t+1}$ for the sizes of the populations in each life-stage at each site, between iteration of the population transition matrix (breeding) and iteration of the dispersal matrix (dispersal), which both occur between each successive time steps. For simplicity of notation, I assume here that breeding happens before dispersal, but the order of the operations can be reversed as required.

The intermediate population states are computed as in earlier models by matrix multiplication of the state vectors $\mathbf{n}_{i,t}$ with the corresponding transition matrix $\mathbf{A}_i$. The ultimate population state for this time point is then given by matrix multiplications - separately for each of the *life stages* - of the intermediate population states against the dispersal matrix, formed from the distance matrix and dispersal function as in the dispersal model for static transition matrices. That is, the matrix multiplication is applied to the other dimension of the population state matrix.

##### Notation

\begin{align}
\mathbf{n}_{j,t+1} &= \mathbf{D}_j \mathbf{n}^*_{j,t+1} \\ \nonumber
\mathbf{n}^*_{i,t+1} &= \mathbf{A}_{i,t} \mathbf{n}_{i,t} \\ \nonumber
\mathbf{D}_{j,i',i} &= d_{j,i',i} / \textstyle\sum_{i=1}^Nd_{j,i',i} \\ \nonumber
d_{j,i',i} &=  e^{-\tau_j D_{i',i}}
\end{align}

##### Code

Input:

- `A_t_fun`: a function yielding for each time point a $N$x$M$x$M$ array of transition matrices for each site
- `n_init`: a (positive) vector of length $M$ or matrix of dimension $N$x$M$ giving the initial population state at each location
- `timesteps`: the number of time-steps to iterate for
- `distance_matrix`: a (possibly sparse) $N$x$N$ matrix of distances between sites
- `tau`: a vector of length $M$ of (positive) dispersal ability parameters for each stage
- `...`: additional named arguments to `A_t_fun`, which may be lists with different elements to be used at each time point

```{r dynamic_dispersal}
dispersal_kernel <- function (distance) {
  exp(-tau * distance)
}

iterations <- iterate_dynamic_matrix(
  matrix_function = A_t_function, 
  initial_state = n_init,
  niter = timesteps,
  distances = distance_matrix,
  dispersal_kernel = dispersal_kernel,
  ...
)

Lambda <- iterations$all_states
```

Note that the final line could be replaced with: `Lambda <- iterations$stable_population` to yield the long-term stable population in the case that dispersal and density-dependent vital rates are required, but neither the effects of environmental stochasticity nor a time series of population sizes is required.


## Species with complex demography

The DSDMs examples covered so far have all used the same two-stage population transition matrix, with adult and juvenile stages. This is by no means a limitation of the DSDM approach, the transition matrix can encode as many life-stages and as much complexity as is required to answer the question at hand and is supported by the available data and prior information.

As an illustration of this, the following example implements a matrix model for a plant species with more complex life history; three adult stages $A_{1-3}$ and two seed bank stages $S_{2-3}$, as described in [@griffithPopulationMatrixModels2005]. As in the original paper, I  simplify the 9 vital rates from the original paper to 4, which I denote, for site $i$: $B_{AA_i}$ (direct recruitment), $B_{AS_i}$ (contribution to the seed bank), $P_{SS_i}$ (persistence in the seed bank), and $P_{SA_i}$ (recruitment from the seed bank). I.e.: $B_{AA_i} = B_{A_1-A_1} = B_{A_2-A_1} = B_{A_3-A_1}$, $B_{AS_i} = B_{A_1-S_2} = B_{A_2-S_2} = B_{A_3-S_2}$, $P_{SS_i} = P_{S_2-S_3}$, and $P_{SA_i} = P_{S_2-A_2} = P_{S_3-A_3}$. In turn, these rates are formed from one rate: the mean number of seeds per plant $S_i$; and 6 probabilities that I concatenate into a single vector $\mathbf{P}_i$ for each site: the fraction of seeds not dispersing ($\mathbf{P}_{i,1} = \text{No }D$), the probability of staying in the soil without germinating ($\mathbf{P}_{i,2} = P_{bank}$, the probability of a seed germinating once it has survived winter $\mathbf{P}_{i,3} = P_{germ}$, the probability of seed germinating and surviving to the first true leaf stage $\mathbf{P}_{i,4} = P_{estab}$, the probability of a seedling surviving from the first true leaf stage to the time of reproduction $\mathbf{P}_{i,5} = P_{surv}$, and the probability of a seed on the ground surviving overwinter to germination time $\mathbf{P}_{i,6} = P_{winter}$. I assume that all seven of these life history parameters vary with environmental covariates, and again model them with linear regression sub-models.

##### Notation 

\begin{align}
\mathbf{A}_i &= \begin{bmatrix} 0 & 0 & B_{AS_i} & B_{AS_i} & B_{AS_i} \\ \nonumber
P_{SS_i} & 0 & 0 & 0 & 0 \\ \nonumber
0 & 0 & B_{AA_i} & B_{AA_i} & B_{AA_i} \\ \nonumber
P_{SA_i} & 0 & 0 & 0 & 0 \\ \nonumber
0 & P_{SA_i} & 0 & 0 & 0 \end{bmatrix} \\ \nonumber
B_{AS_i} &= S_i \mathbf{P}_{i,1} \mathbf{P}_{i,2} \\ \nonumber
B_{AA_i} &= S_i \mathbf{P}_{i,1} P_{SA_i} \\ \nonumber
P_{SS_i} &= \mathbf{P}_{i,6} \mathbf{P}_{i,2} \\ \nonumber
P_{SA_i} &= \mathbf{P}_{i,3} \mathbf{P}_{i,4} \mathbf{P}_{i,5} \\ \nonumber
logit(\mathbf{P}) &= \mathbf{X}\beta_P \\ \nonumber
ln(S_i) &= \mathbf{X}_i\beta_S
\end{align}

##### Code

Input:

- `X`: a $N$x$K$ design matrix for vital rate regression sub-models
- `beta_P`: a $K$x$6$ matrix of regression coefficients for the 6 logit-probabilities in the vector $\mathbf{P}_i$
- `beta_S`: a length $K$ vector of regression coefficients for log-seed-production

```{r complex_demography}
P <- ilogit(X %*% beta_P)
S <- ilogit(X %*% beta_S)

P_SA <- apply(P[, 3:5], 1, "prod")
P_SS <- P[, 6] * P[, 2]
B_AA <- S * P[, 1] * P_SA
B_AS <- S * apply(P[, 1:2], 1, "prod")

N <- nrow(X)
zero <- zeros(N)
col1 <- cbind(zero, P_SS, zero, P_SA, zero)
col2 <- cbind(zeros(N, 4), P_SA)
col3 <- cbind(B_AS, zero, B_AA, zeros(N, 2))
A <- abind(col1, col2, col3, col3, col3, along = 3)
```

## Integral projection models

For species with complex demography and populations that are better represented as size-structureed rather than stage-structured DSDMs can be formed by replacing the MPM with an integral projection model (IPM). As an example, this section presents the equivalent code and notation for the complex, environmentally-explicit spatial IPM for *Protea repens* presented in @merowUsingIntegralProjection2014 and studied as a DSDM in the manuscript. This model is particularly complex - having 8 vital rate submodels, and requiring interpolation of survival rates betwen seedlings and adults.

Whereas matrix population models consider populations with a discrete population distribution over different stages in the model, integral projection models consider populations via a continuous population distribution over individual sizes. The dynamics of a population at site $i$ are therefore modelled as $\mathbf{n}_{i,t+1}(z') = \int \mathbf{K}_{i}(z'|z)\mathbf{n}_{i,t}(z) \, dz$, where $\mathbf{n}_{i,t}(z)$ is an abundance *function* (at site $i$ and time $t$) of sizes $z$, giving the number of individuals of with size around $z$, and $\mathbf{K}_{i}(z'|z)$ is a continuous transition *kernel* at site $i$ mapping these abundance functions between time points. Whereas a matrix population model is described by a matrix-vector multiplication (which sums products between elements of the matrix and vector), the analagous operaiton in this continuous representation is an integration over a convolution. In practice though, this integration and convolution is commonly approximated by discretizing and normalising the kernel $\mathbf{K}_{i}(z'|z)$ to yield a matrix $\mathbf{A}_i$ with a sufficiently large number of size bins $j$ which can be analysed in the same way as a matrix population model. We can therefore compute such a matrix and include it in the DSDM framework.

Whereas MPM-based DSDMs have a single environmental regression submodel for each vital rate, in the IPM these are replaced with submodels that combine the effects of both the environment and individual size. These functions must therefore be manipulated to create arrays (over sites and size bins) that are then combined and normalised to yield an approximation to the IPM. The discretized notation and code to implement these models is therefore somewhat more involved than for MPMs.

##### Notation 

\begin{align}
\mathbf{A}_i &= \mathbf{F}_i + \mathbf{P}_i \\ \nonumber
\mathbf{F}_{i,j',j} &= p_{\text{flower}_{j}} f_{\text{seedheads}_i} f_{\text{seeds}} p_{\text{germ}} f^*_{\text{offsize}_{i,j'}} \\ \nonumber
\mathbf{P}_{i,j',j} &= p_{\text{surv}_{i,j}} f^*_{\text{grow}_{i,j',j}} \\ \nonumber
f^*_{\text{offsize}_{i,j'}} &= f_{\text{offsize}_{i,j'}} / \textstyle\sum_{j'=1}^{M}{f_{\text{offsize}_{i,j'}}} \\ \nonumber
f^*_{\text{nextsize}_{i,j',j}} &= f_{\text{nextsize}_{i,j',j}} / \textstyle\sum_{j'=1}^{M}{f_{\text{nextsize}_{i,j',j}}} \\ \nonumber
logit(p_{\text{flower}}) &= \alpha_{\text{flower}} + z \gamma_{\text{flower}} \\ \nonumber
log(f_{\text{seedheads}}) &= \mathbf{X}_{\text{seedheads}} \beta_{\text{seedheads}} \\ \nonumber
p_{\text{surv}_{i,j}} &= w_j p_{\text{surv-adult}_{i,j}} + (1 - w_j) p_{\text{surv-seedling}_i}  \\ \nonumber
logit(p_{\text{surv-adult}_{i,j}}) &= \mathbf{X}_{\text{surv}_i} \beta_{\text{surv-adult}} + z_j \gamma_{\text{surv-adult}} \\ \nonumber
logit(p_{\text{surv-seedling}_i}) &= \mathbf{X}_{\text{surv}_i} \beta_{\text{surv-seedling}} + z_j \gamma_{\text{surv-seedling}} \\ \nonumber
f_{\text{offsize}_{i,j'}} &= \pi (z_{j'} | \mu_{\text{offsize}_{i,j'}}, \sigma_{\text{offsize}}^2) \\ \nonumber
\mu_{\text{offsize}_{i,j'}} &= \mathbf{X}_{\text{offsize}_i} \beta_{\text{offsize}} \\ \nonumber
f_{\text{nextsize}_{i,j',j}} &= \pi (z_{j'} | z_{j} + \mu_{\text{grow}_{i,j}}, \sigma_{\text{grow}}^2) \\ \nonumber
\mu_{\text{grow}_{i,j}} &= \mathbf{X}_{\text{grow}_i} \beta_{\text{grow}} + z_{j} \gamma_{\text{grow}} \\ \nonumber
\end{align}

where $z$ is a vector of sizes of length $M$; $\mathbf{X}_{\text{seedheads}}$, $\mathbf{X}_{\text{surv}}$, $\mathbf{X}_{\text{offsize}}$, $\mathbf{X}_{\text{grow}}$, $\beta_{\text{seedheads}}$, $\beta_{\text{surv-adult}}$, $\beta_{\text{surv-seedling}}$, $\beta_{\text{offsize}}$, and $\beta_{\text{grow}}$ are design matrices of environmental covariates (and intercept columns) and vectors of regression coefficients for the environmental components of log-seedhead production, logit- adult and seedling survival probabilities, mean offspring size and mean growth rates; $\alpha_{\text{flower}}$, $\gamma_{\text{flower}}$, $\gamma_{\text{surv-adult}}$, $\gamma_{\text{surv-seedling}}$, and $\gamma_{\text{grow}}$ are scalar intercepts and regression coefficients for the effect of size on the logit-probabilities of flowering, adult survival, seedling survival, and on the growth rate; $f_{\text{seeds}}$ and $p_{\text{germ}}$ are scalar parameters for the average number of seeds per seedhead and the probability of germination; $w$ is a vector of weights of length $M$ linearly interpolating size-specific survival between adult and seedling survival probabilities; $\sigma_{\text{offsize}}$ and $\sigma_{\text{grow}}$ are positive scalar parameters giving the standard deviations of offspring sizes and growth rates; and $\pi (x | \mu, \sigma ^ 2)$ denotes the density of univariate normal distribution with parameters $\mu$ and $\sigma^2$ evaluated at $x$.

##### Code

The below code requires some custom functions and a custom greta operation to perform the integration steps and build the kernels efficiently across 3D arrays representing kernels across multiple sites, and to carry out the interpolation of survival rates between adults and seedlings that is implemented in @merowUsingIntegralProjection2014.

Input:

- `matrix_dim`: a positive integer giving $M$ - the dimension of the matrix used to integrate the IPM kernel
- `X_offsize`: a $N$x$K_{\text{offsize}}$ design matrix for the offspring size environmental sub-model
- `X_surv`: a $N$x$K_{\text{surv}}$ design matrix for the survival environmental sub-models
- `X_grow`: a $N$x$K_{\text{grow}}$ design matrix for the growth environmental sub-model
- `X_seedheads`: a $N$x$K_{\text{seedhead}}$ design matrix for the seedhead environmental sub-model
- `beta_offsize`: a length $K_{\text{offsize}}$ vector of environmental regression coefficients for offspring size
- `beta_surv_seedling`: a length $K_{\text{surv}}$ vector of environmental regression coefficients for logit-seedling-survival
- `beta_surv_adult`: a length $K_{\text{surv}}$ vector of environmental regression coefficients for logit-adult-survival
- `beta_grow`: a length $K_{\text{grow}}$ vector of environmental regression coefficients for growth
- `beta_seedheads`: a length $K_{\text{seedhead}}$ vector of environmental regression coefficients for log-seadhead production
- `gamma_surv_seedling`: a scalar coefficient for the effect of size on logit-seedling-survival
- `gamma_surv_adult`: a scalar coefficient for the effect of size on logit-adult-survival
- `gamma_grow`: a scalar coefficient for the effect of size on growth
- `gamma_flower`: a scalar coefficient for the effect of size on logit-flowering-probability
- `germination`: a scalar parameter in $(0,1)$ for germination-probability
- `seeds`: a positive scalar parameter for seed-production
- `alpha_flower`: a scalar intercept parameter for on logit-flowering-probability
- `offsize_sd`: a positive scalar parameter for the standard deviation of the offspring size distribution
- `grow_sd`: a positive scalar parameter for the standard deviation of the growth distribution

```{r ipms}
# normalise a matrix to sum to one rowwise *in exponential space*. Ie. return y
# where: exp(y[i, ]) = exp(x[i, ]) / sum(exp(x[i, ]))
log_normalise <- function (x) {
  op <- greta::.internals$nodes$constructors$op
  op("log_normalise", x, tf_operation = "tf_log_normalise")
}

# tensorflow code for log normalisation
tf_log_normalise <- function (x) {
  sums <- tensorflow::tf$reduce_logsumexp(x, axis = 2L, keepdims = TRUE)
  x - sums
}

# multiply matrix B by each slice of the 3D array A in 3rd dimension
sweep_prod_3d <- function(A, B) {
  n <- dim(A)[1]
  m <- dim(A)[2]
  Al <- aperm(A, c(2, 3, 1))
  dim(Al) <- c(m, n * m)
  Bl <- t(B)
  dim(Bl) <- n * m
  C <- sweep(Al, 2, Bl, "*")
  dim(C) <- c(m, m, n)
  aperm(C, c(3, 1, 2))
}

# create 3D kernel array for Gaussian transitions (working with the log density
# for computational stability)
distribution_kernel <- function (mean_mat, sd, sizes, bin_width) {
  var <- sd ^ 2
  log_constant <- -0.5 * log(2 * pi) - log(sd)
  diff <- kronecker(sizes, mean_mat, FUN = "-")
  log_density <- log(bin_width) + log_constant - (diff ^ 2) / (2 * var)
  log_density <- log_normalise(log_density)
  dim(log_density) <- c(dim(mean_mat), ncol(mean_mat))
  log_density <- aperm(log_density, c(1, 3, 2))
  exp(log_density)
}

interpolate_survival <- function (adult_surv, seedling_surv, sizes) {
  range <- 0.728 - 0.182
  weights <- 0.728 / range  - (sizes / range)
  weights[sizes > 0.728] <- 0
  weights[sizes <= 0.182] <- 1
  weighted_seedling_surv <- sweep(seedling_surv, 2, weights, FUN = "*")
  weighted_adult_surv <- sweep(adult_surv, 2, 1 - weights, FUN = "*")
  weighted_seedling_surv + weighted_adult_surv
}

min_size <- 0
max_size <- 5
bounds <- min_size + (0:matrix_dim) * (max_size - min_size) / matrix_dim
sizes <- 0.5 * (bounds[-(matrix_dim + 1)] + bounds[-1])
bin_width <- sizes[2] - sizes[1]

# environmental components of sub models
offsize <- X_offsize %*% beta_offsize
grow <- X_grow %*% beta_grow
env_surv_seedling <- X_surv %*% beta_surv_seedling
env_surv_adult <- X_surv %*% beta_surv_adult
env_seedheads <- X_seedheads %*% beta_seedheads

# size components of submodels
flower <- ilogit(alpha_flower + sizes * gamma_flower)
size_surv_seedling <- sizes * gamma_surv_seedling
size_surv_adult <- sizes * gamma_surv_adult
size_seedheads <- sizes * gamma_seedheads

# vital rates at all sites
seedheads <- exp(kronecker(size_seedheads, env_seedheads))
surv_seedling <- ilogit(kronecker(size_surv_seedling, env_surv_seedling))
surv_adult <- ilogit(kronecker(size_surv_adult, env_surv_adult))

# kernelise growth * survival and recruitment * offspring size, and combine
survival <- interpolate_survival(surv_adult, surv_seedling, sizes)
next_size_density <- distribution_kernel(sizes + grow, grow_sd, sizes, bin_width)
P <- sweep_prod_3d(next_size_density, survival)
recruits <- flower * seedheads * seeds * germ
offsize_density <- distribution_kernel(offsize, offsize_sd, sizes, bin_width)
F <- sweep_prod_3d(offsize_density, recruits)
A <- P + F
```

## Biotic interactions

Simultaneous demographic species distribution modelling of multiple species can be achieved by replacing the population transition matrices at each site $\mathbf{A}_i$ with a block-diagonal matrix that has the population transition matrices for each species on the diagonal. For model of $L$ species each with $M$ life-stages $\mathbf{A}_i$ therefore has dimension $LM$x$LM$. The off-diagonal blocks are all zero-matrices, since an individual can neither change species nor produce offspring of another species. Interactions between species can be encoded via density-dependent vital rates, with the density of both conspecific and intraspecific populations affecting the vital rates of each species.

As in the single-species density-dependent vital rate model above the relative population density for each species is computed by iteration; at each time-step recalculating the transition matrix from population densities of all species and matrix-multiplying it by the current population density vector to obtain the subsequent population density vector. The transition matrix $\mathbf{A}_i$ is sparse; with only 1 in $L$ elements being non-zero. This iteration can therefore be carried out efficiently with sparse matrix-multiplication operations.


##### Notation

\begin{align}
\Lambda_{i,l} &= \mathbf{N}_{l,i,T} \\ \nonumber
\mathbf{n}_{i,t+1} &= \mathbf{A}^*_{i,t+1} \mathbf{n}_{i,t} \\ \nonumber
\mathbf{A}^*_{i,t+1} &= \begin{bmatrix} \mathbf{A}_{1,i,t+1} & & \dots & & 0 \\
& \ddots & & & \\
\vdots & & \mathbf{A}_{l,i,t+1} & & \vdots \\
& & & \ddots & \\
0 & & \dots & & \mathbf{A}_{L,i,t+1} \end{bmatrix} \\ \nonumber
\mathbf{A}_{l,i,t+1} &= \begin{bmatrix} \mathbf{F}_{l,i,t} \cdot \mathbf{S}_{J_{l,i,t}} & \mathbf{F}_{l,i,t} \cdot \mathbf{S}_{A_{l,i,t}} \\ \mathbf{S}_{J_{l,i,t}} & \mathbf{S}_{A_{l,i,t}}  \end{bmatrix}  \\ \nonumber
ln(\mathbf{F}_{t}) &= \mathbf{X} \beta_F + \mathbf{N}_{t} \mathbf{\alpha}_F \\ \nonumber
logit(\mathbf{S}_{A_{t}}) &= \mathbf{X} \beta_S + \mathbf{N}_{t} \mathbf{\alpha}_S \\ \nonumber
logit(\mathbf{S}_{J_{l,i,t}}) &= logit(\mathbf{S}_{A_{l,i,t}}) - \gamma_l \\ \nonumber
\mathbf{N}_{l,i,t} &= \textstyle\sum_{j=1+(l - 1)}^{lM}{\mathbf{n}_{i,j,t}}
\end{align}

where $\mathbf{F}$, $\mathbf{S}_A$, $\mathbf{S}_J$, and $\mathbf{N}$ are 3D arrays with dimension $L$x$N$x$T$ giving the fecundity, adult and juvenile survival and relative population density of each species $l$ at site $i$ at time $t$, computed from $K$x$L$ matrices $\beta_F$ and $\beta_S$ or regression coefficients for the sub-models for each of species, and $L$x$L$ matrices $\mathbf{\alpha}_F$ and $\mathbf{\alpha}_S$ of density-dependence effects between specie. I.e. each element $\mathbf{\alpha}_{F_{l,l'}}$ gives the effect of the density of the population of species $l'$ on the log-fecundity of species $l$. Off-diagonal elements of $\mathbf{\alpha}_F$ and $\mathbf{\alpha}_S$  quantify fecundity- and survival-mediated interactions between species, whilst the diagonal elements quantify conspecific density-dependence.

##### Code

Input:

- `X`: a $N$x$K$ design matrix for vital rate regression sub-models
- `beta_F`: a $K$x$L$ matrix of regression coefficients for log-fecundity for each species
- `beta_S`: a $K$x$L$ matrix of regression coefficients for logit-survival for each species
- `alpha_F`: a $L$x$L$ matrix of the intra- and inter-specific effects of population density on log-fecundity
- `alpha_S`: a $L$x$L$ matrix of the intra- and inter-specific effects of population density on logit-survival
- `gamma`: a (positive) vector of length $K$ for the differences in logit-survival between adults and juveniles for each species

```{r biotic_interactions}
A_t_function <- function(state, iter, log_F, logit_S, alpha_F, alpha_S, gamma, dd_weights) {
  
  N <- state %*% dd_weights
  log_F_t <-  base_log_F + N %*% alpha_F
  logit_S_A_t <- base_logit_S + N %*% alpha_S
  
  F_t <- exp(log_F_t)
  S_A_t <- ilogit(logit_S_A_t)
  S_J_t <- ilogit(sweep(logit_S_A, 2, gamma, "-"))

  top <- rbind(F_t * S_J_t, F_t * S_A_t)
  bottom <- rbind(S_J_t, S_A_t)
  dim(top) <- c(nrow(N), ncol(N) * 2)
  dim(bottom) <- c(nrow(N), ncol(N) * 2)
  A_t <- abind(top, bottom, along = 3)
  A_t
  
}

# weights matrix to aggregate stage-states for each species
L <- length(gamma)
dd_weights <- diag(L)[rep(1:L, each = M), ]

iterations <- iterate_dynamic_matrix(
  matrix_function = A_t_function, 
  base_log_F = X %*% beta_F,
  base_logit_S = X %*% beta_S,
  alpha_F = alpha_F,
  alpha_S = alpha_S,
  gamma = gamma,
  dd_weights = dd_weights
)

Lambda <- iterations$stable_population
```

## Evolutionary dynamics

Similarly to the biotic interactions model, we can consider a population of single species but with $L$ different genotypes with a blocked transition matrix. In this model, the genotypes are linked via reproduction rather than density-dependent vital rates. The $L$x$L$ matrix $\mathbf{m}$ quantifies mutation rates between different genotypes. For an individual of genotype $l$, each of its offspring has probability $\mathbf{m}_{l,l'}$ of being of genotype $l'$. Each genotype has its own vital rate sub-models, representing a linked phenotype driving population dynamics for that genotype. By analysing the combined transition matrix $\mathbf{A}^*_i$ at each site $i$ with different environmental covariates, the model can consider how selection for each genotype varies across the environment, and predict the genetic makeup of populations. Note that this is just one approach to considering multiple genotypes and natural selection in a matrix population model, see e.g. @devriesSelectionTwosexStagestructured2019.

This model is compatible with both static and dynamic transition matrices. In the static case, the expected abundance $\Lambda_{l,i}$ of each genotype $l$ at each site $i$ can computed by the product of the expected total abundance $\Lambda^*_i$ (computed via an abundance model as in the basic model) and the stable distribution of genotypes, calculated by summing the dominant eigenvector over the stages in each genotype and standardising to sum to one. In the dynamic case relative abundances can be calculated in the same way as for the biotic interaction model.

##### Notation

\begin{align}
\Lambda_{l,i} &= \Lambda^*_i \mathbf{v}_{l,i} / \textstyle\sum_{l=1}^{L}{\mathbf{v}_{l,i}} \\ \nonumber
\Lambda^*_i &= ln(1 + e^{K_i})  \\ \nonumber
K_i &= (\lambda_i - 1) \alpha \\ \nonumber
\mathbf{v}_{l,i} &= \textstyle\sum_{j=1}^{M}{\mathbf{v}^*_{j+(l-1),i}} \\ \nonumber
\mathbf{v}^*_i &= eigvec(\mathbf{A}^*_i) \\ \nonumber
\lambda_i &= eigval(\mathbf{A}^*_i) \\ \nonumber
\mathbf{A}^*_i &= \begin{bmatrix} \mathbf{A}_{1,i} & \mathbf{F}_{1,2,i} & \dots & \mathbf{F}_{1,l',i} & \dots & \mathbf{F}_{1,L,i}\\
\mathbf{F}_{2,1,i} & \mathbf{A}_{2,i} & \dots & \mathbf{F}_{2,l',i} & \dots & \mathbf{F}_{2,L,i} \\
\vdots & \vdots & \ddots & \vdots & &  \vdots \\
\mathbf{F}_{l,1,i} & \mathbf{F}_{l,2,i} & \dots & \mathbf{A}_{l,i} & \dots & \mathbf{F}_{l,L,i} \\
\vdots & \vdots &  & \vdots & \ddots & \vdots \\
\mathbf{F}_{L,1,i} & \mathbf{F}_{L,2,i} & \dots & \mathbf{F}_{L,l',i} & \dots & \mathbf{A}_{L,i} \end{bmatrix} \\ \nonumber
\mathbf{F}_{l,l',i} &= \begin{bmatrix} \mathbf{m}_{l,l'} \cdot F_{l',i} \cdot S_{J_{l',i}} & \mathbf{m}_{l,l'} \cdot F_{l',i} \cdot S_{A_{l',i}} \\ 0 & 0 \end{bmatrix} \\ \nonumber
\mathbf{A}_{l,i} &= \begin{bmatrix} \mathbf{m}_{l,l} \cdot F_{l,i} \cdot S_{J_{l,i}} & \mathbf{m}_{l,l} \cdot F_{l,i} \cdot S_{A_{l,i}} \\ S_{J_{l,i}} & S_{A_{l,i}} \end{bmatrix}  \\ \nonumber
ln(\mathbf{F}) &= \mathbf{X} \beta_F \\ \nonumber
logit(\mathbf{S}_{A}) &= \mathbf{X} \beta_S \\ \nonumber
logit(\mathbf{S}_{J_{l,i}}) &= logit(\mathbf{S}_{A_{l,i}}) - \gamma_l
\end{align}

where $\mathbf{F}$, $\mathbf{S}_A$, $\mathbf{S}_J$, and $\mathbf{N}$ are $L$x$N$ matrices giving the fecundity, adult and juvenile survival and relative population density of each genotype $l$ at site $i$, computed from $K$x$L$ matrices $\beta_F$ and $\beta_S$ of regression coefficients for the sub-models for each of species. $\mathbf{m}$ is an $L$x$L$ matrix of positive values with columns summing to one, giving the probabilities of a parent of one genotype producing offspring of each genotype. 

An equivalent notation for $\mathbf{A}^*_i$ using Kronecker products of matrices is as follows:

\begin{align}
\mathbf{A}^*_i &=  (\mathbf{1} \otimes \mathbf{R}_i^T) \odot (\mathbf{m} \otimes \mathbf{B} + \mathbf{I} \otimes \mathbf{C})\\ \nonumber 
\mathbf{R}_i &= \mathbf{F}_i \otimes \mathbf{B}^T \odot (\mathbf{S}_{J_i} \otimes \mathbf{B} + \mathbf{S}_{A_i} \otimes \mathbf{C})
\end{align}

where $\mathbf{B}$ is an $M$x$M$ matrix with ones on the first row and zeros elsewhere (i.e.. a mask indicating cells representing fecundity rates), $\mathbf{C}$ is its reverse (zeros on the first row, ones elsewhere) $\mathbf{1}$ is length $L$ vector of ones, $\mathbf{I}$ is an identity matrix of dimension $L$, and $\odot$ and $\otimes$ represent the Hadamard (element-wise) and Kronecker products respectively.

This is the form that I use in the code below, vectorised across all $N$ sites, since it is more computationally efficient to carry out the calculations in this way in greta.

##### Code

Input:

- `X`: a $N$x$K$ design matrix for vital rate regression sub-models
- `beta_F`: a $K$x$L$ matrix of regression coefficients for log-fecundity for each genotype
- `beta_S`: a $K$x$L$ matrix of regression coefficients for logit-survival for each genotype
- `m`: a $L$x$L$ matrix of the transition (mutation) rates between genotypes, with columns summing to one
- `gamma`: a (positive) vector of length $K$ for the differences in logit-survival between adults and juveniles for each species

```{r evolutionary_dynamics}
# vital rate models
log_F<- X %*% beta_F
logit_S<- X %*% beta_S
F <- exp(log_F)
S_A <- plogis(logit_S)
S_J <- plogis(logit_S - gamma)

L <- length(gamma)
N <- nrow(X)
M <- 2
padding <- zeros(N, L * M)
B <- zeros(M, M)
B[1, ] <- 1
C <- 1 - B
dd_weights <- diag(L)[rep(1:L, each = M), ]

# array A_star of transition matrices
mutation <- kronecker(m, B) + kronecker(diag(L), C)

F_rep <- do.call(rbind, replicate(M, F, simplify = FALSE))
dim(F_rep) <- c(N, L * M)
F_kron_tB <- abind(F_rep, padding, along = 3)

SJ_rep <- do.call(cbind, replicate(M, S_J, simplify = FALSE))
SJ_kron_B <- rbind(SJ_rep, padding)
dim(SJ_kron_B) <- c(N, L * 2,  M)

SA_rep <- do.call(cbind, replicate(M, S_A, simplify = FALSE))
SA_kron_C <- rbind(padding, SA_rep)
dim(SA_kron_C) <- c(N, L * 2,  M)

R <- F_kron_tB + SJ_kron_B + SA_kron_C
one_kron_R <- do.call(abind, c(replicate(L, R, simplify = FALSE), list(along = 3)))
dim(one_kron_R) <- c(N, L * M, L * M)
one_kron_R <- aperm(one_kron_R, c(1, 3, 2))

# do multiplication across N as a matrix
dim(one_kron_R) <- c(N, L ^ 2 * M ^ 2)
dim(mutation) <- c(L ^ 2 * M ^ 2)
A_star <- sweep(one_kron_R, 2, mutation, "*")
dim(A_star) <- c(N, L * M, L * M)

analysis <- iterate_matrix(A_star)
v_star <- analysis$stable_abundance_distribution
v_standardised <- analysis$stable_abundance_distribution %*% dd_weights
lambda <- analysis$lambda
K <- (lambda - 1) * alpha
Lambda_star <- log1pe(K)
Lambda <- Lambda_star * v_standardised
```


# References
