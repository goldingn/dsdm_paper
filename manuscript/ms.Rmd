---
title: "Demographic Species Distribution Models"
author:
  - Nick Golding
  - School of BioSciences, University of Melbourne, Parkville VIC, Australia
bibliography: dsdm.bib
csl: mee.csl
output:
  pdf_document:
  word_document:
    fig_caption: true
    highlight: null
header-includes: \usepackage{float}
---

Word Count: `r wordcountaddin::word_count()`

# Abstract

1. Quantifying the distributions and abundances of species is a problem central to ecology. Correlative species distribution models (SDMs) are are widely used, and whilst they perform well at predicting current distributions, their lack of ecological mechanism means they often perform poorly at predicting how distributions will change in response to environmental change, habitat loss, or human interventions.

2. I propose demographic species distribution models (DSDMs): matrix population models that are statistically fitted to species distribution data to form a mechanistic statistical model for species distributions. This approach differs from existing mechanistic SDMs in that it makes use of commonly available species distribution data (abundance, presence-only, or presence-absence), explicitly models how vital rates such as fecundity and survival vary over space, and enables - but does not require - the incorporation of prior knowledge of a species' ecology. 

3. Example applications mapping the Carolina Chickadee in North Ameerica, and a species of Protea in southern Africa indicate that DSDMs have similar predictive performance to SDMs and produce plausible spatial estimates of vital rates. Even when DSDMs are provided with little information on the ecology of the target species, predictions of distributions are well-identified. Where there is uncertainty about a species' population dynamics, this uncertainty is reflected in more uncertain estimates of vital rates.

4. DSDMs can be extended to consider features of population dynamics such as dispersal, density dependence, and biotic interactions. Being specifically designed for efficient statistical inference, they are a promising replacement for correlative SDMs where study aims require the incorporation of more ecological mechanism.

```{r knitrOpts, echo = FALSE, cache = FALSE, eval = TRUE}
# set up knitr options
knitr::opts_chunk$set(fig.path = "figs/",
               message = FALSE,
               warning = FALSE,
               fig.align = "center",
               fig.pos = "H",
               dev = c("png"),
               cache = TRUE)
```


```{r stats, echo = FALSE, cache = FALSE, eval = TRUE}

# get all cached drake objects
library(storr)
cache <- storr_rds(drake::find_cache())

# bbs objects

# data size
bbs_data <- cache$get("bbs_data_list")
bbs_n_train <- nrow(bbs_data$train)
bbs_n_test <- nrow(bbs_data$test)

# timings
bbs_time <- cache$get("bbs_draws_list")$timing["elapsed"]
bbs_analytic_time <- cache$get("bbs_analytic_draws_list")$timing["elapsed"]

# effective sample sizes
bbs_draws_sry <- cache$get("bbs_draws_summary")
bbs_neff <- round(min(bbs_draws_sry$n_eff), -1)

# the R hat below which all parameter estimates fall (print 1.01 if it's less
# than that)
bbs_max_rhat <- max(bbs_draws_sry$r_hat$psrf[, 1])
bbs_max_rhat <- max(bbs_max_rhat, 1.01)

# format parameter estimates
bbs_means <- bbs_draws_sry$summary$statistics[, "Mean"]
bbs_cis <- bbs_draws_sry$summary$quantiles[, c("2.5%", "97.5%")]
bbs_cov_names <- colnames(bbs_data$x_train)
bbs_params <- cbind(data.frame(mean = bbs_means), bbs_cis)
bbs_params <- bbs_params[seq_len(2 * length(bbs_cov_names)), ]

mean_text <- format(round(bbs_params$mean, 3))
ci_text <- sprintf(
  "(%s\\ -\\ %s)",
  format(round(bbs_params$`2.5%`, 2)),
  format(round(bbs_params$`97.5%`, 2))
)

sig <- sign(bbs_params$`97.5%`) == sign(bbs_params$`2.5%`)
mean_text[sig] <- paste0("\\textbf{", mean_text[sig], "}")
text <- paste(mean_text, ci_text)

name_lookup <- matrix(
  c("(Intercept)", "Intercept",
    "pcMix", "Mixed forest cover",
    "pcDec", "Deciduous forest cover",
    "pcCon", "Coniferous forest cover",
    "bio1", "Annual mean temperature",
    "bio6", "Min. temperature of coldest month",
    "bio12", "Annual precipitation"),
  ncol = 2, byrow = TRUE
)

bbs_coef_mat <- matrix(text, ncol = 2)
rownames(bbs_coef_mat) <- name_lookup[match(bbs_cov_names, name_lookup[, 1]), 2]
colnames(bbs_coef_mat) <- c("fecundity", "adult survival")

# statistics comparing DSDM and GLM
bbs_stats <- cache$get("bbs_stats")
bbs_stats <- lapply(bbs_stats, round, 3)

```


# Introduction

Species distribution modelling is widely used in ecology, with models informing ecological theory [@elithSpeciesDistributionModels2009], and the resulting maps used in a number of applied disciplines, including conservation [@guisanPredictingSpeciesDistributions2013] and public health [@purseTrackingDistributionImpacts2015].
Correlative statistical models, using environmental variables as predictors, are very widely used for predicting species distributions as they describe and interpolate distributions well, with minimal required prior knowledge of the system [@elithSpeciesDistributionModels2009].

However the arbitrary, flexible functional forms of these correlative species distribution models (SDMs) make them poor at predicting to novel conditions [@dormannCorrelationProcessSpecies2012].
Moreover, models of species distributions are often needed to predict new distributions in response to changes other than the environmental predictors that correlative SDMs rely upon. For instance

Whilst users typically have some knowledge of the processes driving these aspects of species distributions &mdash; such as the species' life history, approximate survival and fecundity rates or dispersal ability &mdash; incorporating this knowledge into correlative statistical models is problematic.
On the other hand, ecologists rarely have enough information to accurately predict species distributions from their knowledge of the species life history and demographics alone, since quantifying how vital rates vary over space typically requires large-scale long-term field studies [@merowUsingIntegralProjection2014] or detailed physiological modelling [@kearneyModellingSpeciesDistributions2008].

When no single modelling approach is available that fits their needs, species distribution modellers needing to incorporate more ecological mechanism into their predictions must employ a number of tricks to shoehorn their ecological knowledge into correlative SDMs.
For instance, manipulating distribution data to remove the signal of dispersal limitation before model fitting [@elithArtModellingRangeshifting2010], or treating correlative SDM predictions as a proxy for habitat carrying capacity in a secondary spatial population simulation model [@andersonDynamicsRangeMargins2009].
Whilst these approaches can be effective, they often make strong and questionable assumptions (for example about the relationship between habitat suitability and carrying capacity) and require the modeller to focus on implementation details, rather than the ecology of the species they are studying.
Models that explicitly consider the demographic processes relevant to distribution modelling task in hand are therefore appealing.

A number of models have been made to improve the realism in species distribution models, whilst still enabling them to be fitted to the distribution data that are commonly available.
For example, dynamic range models (DRMs) extend correlative SDMs by explicitly modelling dispersal processes and spatial variation in population growth rates [@pagelForecastingSpeciesRanges2012].
DRMs model population growth rates using a correlative model and environmental covariates, just as a correlative SDM models the abundance or probability of presence of a species. 
DRMs can also be fitted to distribution data, though they are intended for use with time series of abundance or presence-only data, since repeat observations are needed to accurately quantify population growth rates and dispersal.

Because they do not model vital rates directly DRMs, like correlative SDMs, are unable to predict the impact on distributions of a change &mdash; for example a conservation intervention like predator control &mdash; that affects a single vital rate.

<explicitly modelling vital rates, because it's useful>

<MPMs & IPMs do this at a single location - widely used in ecology, and even whole databases available>

By contrast, matrix population models and integral projection models (IPMs) are demographic models of single populations that construct and analyse a transition matrix representing key demographic processes [@merowAdvancingPopulationEcology2014].
Spatial IPMs extend this idea to map distributions by modelling demographic rates as a function of covariates, then analysing transition matrices under different conditions to map emergent demographic quantities (such as the intrinsic growth rate) to characterize the distribution of a species [@merowUsingIntegralProjection2014].

<SIPMs (DDMs in Merow - note on nomenclature) apply these to large spatial scales. Whilst they rely on vast amnounts field data (so are not applicable in most SDM situations), they provide a link between demography and distribution, making it possible to perform statistical inference on them using distribution data. This is what I call a DSDM - the subject of this manuscript.>

Whilst the concept is simple, it is not obvious that multiple spatial surfaces (vital rate distributions) can be inferred from a single spatial dataset of a species' distribution.
Nor is it obvious that such a model can be fitted to data with sufficiently ease and speed to be useful to ecologists.
The rest of this manuscript addresses these issues, introducing the basic model and describing a number of potential extensions.
Example 1 illustrates a basic DSDM for presence/absence distribution data, requiring minimal prior knowledge and demonstrates that spatial variation in the two different vital rates can indeed be disentangled.
Example 2 then develops a more complex DSDM incorporating detailed knowledge of a species' ecology, and illustrates that the relationships between vital rates and environmental variables learned from distribution data do broadly agree with field-derived estimates.


# Demographic Species Distribution Models

<general equations - a number of options for observation models>
<blame link between growth rate and probability of presence on Jorn, point reader to section on extensions for density-dependent solution>
<suggest doing Bayesian inference - propagate uncertainty and incorporate any prior information to help the model disentangle the spatial signal>

```{r schematic, echo = FALSE, fig.cap = "Demographic species distribution models in the context of other models of distribution and demography. A) Correlative species distribution models (SDMs) use a correlative mathematical relationship - such as a logit-linear model - to predict a species' distribution from spatial covariates. The predicted distribution (for a given set of parameter values) is compared to observed distribution data using an observation model - such as a Bernoulli distribution, for presence-absence data. Statistical inference is performed to infer the correlative model parameters from the distribution data. B) Matrix population models (MPMs) and integral projection models (IPMs) combine either direct estimates, or correlative models, of vital rates like survival and fecundity to predict demographic quantities such as the population growth rate. Spatial IPMs apply these models to covariate values at each pixel in the landscape, and therefore map the distributions of vital rates and species. Unlike correlative SDMs, the parameters of MPMs, IPMs, and spatial IPMs are inferred from data on population dynamics at specific locations, rather than distribution data. Demographic SDMs (proposed here) combine correlative SDMs and spatial IPMs; replacing the arbitrary correlative model in a correlative SDM with an MPM or IPM, and inferring model parameters by fitting the whole model statistically to observed distributions. Equations correspond roughly to the model considered in Example 1, but represent a wide range of correlative, population dynamic, and observation models that could be used in this framework, with choice of function $f()$ dictating the relationship between the species' transition matrix and relative abundance.", out.width = "\\textwidth"}
knitr::include_graphics("../figures/schematic.png")
```


# Example 1. A DSDM for the Carolina Chickadee

This section demonstrates the construction, fitting and analysis of a basic DSDM the Carolina Chickadee *Poecile carolinensis*, a small passerine bird, for the contiguous USA.
A two-stage matrix population model for the species has previously been developed [@ryuDevelopingPopulationModels2016], and used to carry out a population viability analysis. Fecundity and survival rates for adults and juveniles were estimated from mark-recapture data at a number of survey stations across the United States, and represent a single (spatial) average population over the survey stations where the species was detected.
The spatially static matrix population model from this previous analysis was defined by transition matrix $\mathbf{A}$:

\begin{align}
\mathbf{A} = \begin{bmatrix} F \cdot S_J & F \cdot S_A \\ S_J & S_A \end{bmatrix}
\end{align}

where and $F$, $S_J$, and $S_A$ are estimates of annual fecundity, juvenile survival, and adult survival rates respectively for the entire North American population of the species.
Tables 2-4 in @ryuDevelopingPopulationModels2016 give the following parameter estimates, along with estimates of variability expressed here as standard deviations: $F$ = 0.58 ($\pm$ 0.25), $S_J$ = 0.49 ($\pm$ 0.20), $S_A$ = 0.71 ($\pm$ 0.20).

Whilst these estimates provide detailed information with which to predict population trajectories for the US as a whole, they do not provide any information about how vital rates vary across the continent, and so don't help us to predict the species' distribution.
To this end, I constructed a DSDM based on this model, but where the population in each location $i$ has a distinct set of vital rates, each given by a vital rate regression to model how vital rates vary according to environmental covariates:

\begin{align}
\mathbf{A}_i &= \begin{bmatrix} F_i \cdot S_{J_i} & F_i \cdot S_{A_i} \\ S_{J_i} & S_{A_i}  \end{bmatrix} \\ \nonumber
ln(F_i) &= \mathbf{X}_i\beta_F \\ \nonumber
logit(S_{A_i}) &= \mathbf{X}_i\beta_S \\ \nonumber
logit(S_{J_i}) &= logit(S_{A_i}) - \gamma
\end{align}

where $\mathbf{X}$ is a design matrix of environmental covariates and an intercept dummy variable for the fecundity and survival submodels and $\beta_F$ and $\beta_S$ are vectors of regression coefficients for the two submodels.
Rather than separately modelling spatial variation in adult and juvenile fecundity, I assume that the environmental predictors of survival are the same in both stages, but that juvenile survival differs from adult survival by a constant amount on the logit scale, this maintains the (0,1) constraint on survival probabilities.

I specify an observation model for presence-absence data:

\begin{align}
y_i &\sim Bernoulli(p_i) \\ \nonumber
p_i &= 1 - e^{-\Lambda_i} \\ \nonumber
\Lambda_i &= ln(1 + e^{K_i})  \\ \nonumber
K_i &= (\lambda_i - 1) \alpha \\ \nonumber
\lambda_i &= eigval(\mathbf{A}_i)
\end{align}

where $eigval()$ denotes the dominant eigenvalue of a symmetric matrix, yielding the intrinsic growth rate $\lambda_i$ of the population at location $i$. The theoretical carrying capacity at each site $K_i$ is computed from the carrying capacity relationship of the Beverton-Holt model. $K_i$ has negative values $\lambda_i < 1$, so it is transformed to an always-positive relative abundance parameter $\Lambda_i$ via the softplus function. The softplus transformation is a smooth version of the Heaviside function (which sets negative values to zero), so $\Lambda_i$ closely approximates $K_i$ for most $lambda_i > 1$, and rapidly approaches zero below $lambda_i = 1$. This formulation is statistically convenient, but as discussed below, DSDMs can incorporate more complex and realistic forms of density-dependence if required. 
The parameter $\alpha$ controls the relationship between the intrinsic population growth rate and relative abundance. It is a compound of two parameters that are only identified together: the Beverton-Holt density-dependence parameter relating growth rates to carrying capacities; and the detection rate &mdash; the fraction of individuals in the total population that are detected during a presence-absence survey at site $i$.  
From $\Lambda_i$, we obtain the probability $p_i$ of detecting (one or more individuals of) the species $y_i$, under a poisson sampling distribution [@pagelQuantifyingRangewideVariation2014].

This model provides a general DSDM structure for presence-absence data that is applicable to a range species. I refined it for this application by encoding knowledge of the ecology of the Carolina Chickadee in prior distributions over the model parameters:

\begin{align}
\beta_{F} &\sim N(\mu_F, \mathbf{\Sigma}_F) \\ \nonumber
\beta_{S} &\sim N(\mu_S, \mathbf{\Sigma}_S) \\ \nonumber
\gamma &\sim N(1.17, 2.10) \\ \nonumber
\alpha &\sim U(0, \infty)
\end{align}.

The spatially-averaged fecundity and adult survival estimates from @ryuDevelopingPopulationModels2016 were used to define priors on regression coefficients for the vital rate submodels. These estimated vital rates correspond to populations at the $J$ survey stations used in the recapture analysis (station names provided in the supplemental data to @ryuDevelopingPopulationModels2016) &mdash; locations where the species occurs. I defined a prior on $\beta_F$ and $\beta_S$ such that values were *a priori* more likely if they resulted in estimates of $F_j$ and $S_{A_j}$, for each survey station location $j$, that were more consistent with the estimates in @ryuDevelopingPopulationModels2016.
First, the means and variances of these estimates were used to calculate equivalent parameters of univariate normal distributions on the link-scale of the regression submodels, resulting in the implied priors: $ln(F_j) \sim N(-0.63, 0.18)$, $logit(S_{A_j}) \sim N(1.12, 1.28)$, and $logit(S_{J_j}) \sim N(-0.05, 0.85)$.
These normally-distributed implied priors correspond exactly to multivariate normal priors on the vectors of regression coefficients, since the matrix-multiplication that maps between regression coefficients and link-scale response is an affine transformation, under which the multivariate normal distribution is closed. The parameters of the priors over $\beta_F$ are therefore given by: $\mu_F = \mathbf{X}_*^{-1}(\text{-}0.63\, \mathbf{I})$ and $\mathbf{\Sigma}_F = \mathbf{X}_*^{-1} (0.18\,\mathbf{I}) \mathbf{X}_*^{-T}$, where $\mathbf{X}_*$ denotes the design matrix over the $J$ survey stations, $\mathbf{X}_*^{-1}$ its Moore-Penrose pseudoinverse, $\mathbf{X}_*^{-T}$ the transpose of that pseudoinverse, and $\mathbf{I}$ an identity matrix of dimension $J$. The prior parameters $\mu_S$ and $\mathbf{\Sigma}_S$ were defined in the same way using the implied prior parameters over $logit(S_{A_j})$: 1.12, and 1.28.
Note that these priors do not provide any information on the direction of the relationships between vital rates and environmental covariates (the intercept elements of $\mu_F$ and $\mu_S$ are informed, but the prior mean for the other terms is $\approx 0$), but by providing information on plausible magnitudes of, and correlations between these parameters the prior favours regression equations that pass close to the vital rate estimates at $F_j$ and $S_j$.
The prior for $\gamma$, the logit-difference between adult and juvenile survival, is given by the difference between the implied normal priors on logit-survival of adults and juveniles, which is also normal.
In the absence of any meaningful prior information for the competition effects or detection rates, I assigned $\alpha$ an improper uniform prior on all positive values.

I fitted the model to a random subset of `r bbs_n_train` presence-absence records from the North American Breeding Bird Survey in 2015 [@sauerNorthAmericanBreeding2011]. I used five environmental covariates in $\mathbf{X}$: percentage cover of deciduous forest, coniferous forest, and mixed forest (to represent breeding habitat for this species) mean temperature (to capture thermal limits on survival of the species), and annual precipitation (as a proxy for insect abundance and plant growth, food sources for this species). The forest cover layers were obtained from the maxlike R package [@royleLikelihoodAnalysisSpecies2012], and the climatic covariates were bioclim layers 1 and 12 from the WorldClim 2.0 dataset [@fickWorldClimNew1km2017]. In general, ecological knowledge could be used to select separate covariates to use for each of the submodels. However, in the absence of a strong belief that any of these covariates would affect only one vital rate, all six covariates were used in both submodels. These covariate values were centred and scaled (before calculation of the priors on $\beta_F$ and $\beta_S$) to enable comparison of regression coefficients as effect sizes.

Inference was by Hamiltonian Monte Carlo using the R package greta [@goldingGretaSimpleScalable2019] and its extension package greta.dynamics [@goldingGretaDynamicsModelling2019] for modelling dynamical systems (discussed in *Computation* below). Four chains were run for 1000 iterations each (after 1000 discarded iterations during which the sampler was burnt-in and tuned), which was sufficent to ensure convergence (`r sprintf("$\\hat{R}\\le%s$", format(bbs_max_rhat, digits = 3))`), and yield at least `r round(bbs_neff)` effective samples for every model parameter. This took `r round(bbs_time)` seconds on a laptop computer. Table 1 reports estimates of the posterior distributions over these parameters.

```{r bbs_beta, echo = FALSE, cache = FALSE}
knitr::kable(bbs_coef_mat, align = "r", caption = "Posterior means and 95% credible intervals for regression coefficients in the fecundity and survival submodels ($\\beta_F$ and $\\beta_S$). All covariates are standardised, enabling comparison of coefficient estimates as effect sizes. Posterior means are bolded where credible intervals do not overlap zero.")
```

Prediction of the DSDM to new locations proceeds as with any Bayesian model by substituting the design matrix $\mathbf{X}$ for observed data with a design matrix corresponding to the prediction locations, and for each posterior sample of parameter values, calculating the value of the variable of interest. This yields a posterior distribution over predictions that incorporates uncertainty in parameter values. 
The fitted DSDM yields (posterior mean) predictions of the probability of presence similar to those from a correlative SDM (Fig. 2A): predictions from a maximum likelihood logistic regression model fitted to the same data had a correlation of `r bbs_stats$glm_dsdm_correl` with the DSDM predictions, and similar AUC and correlation when compared with the true data in the `r bbs_n_test` survey locations not used to train the model (GLM: AUC = `r bbs_stats$glm_auc`, correlation = `r bbs_stats$glm_pa_correl`, DSDM: AUC = `r bbs_stats$dsdm_auc`, correlation = `r bbs_stats$dsdm_pa_correl`).
Unlike a correlative SDM, the DSDM also predicts spatial variation in the survival (Fig. 2B) and fecundity (Fig. 2C) rates.
The species’ range limits (in this case due to the fundamental niche) can be mapped by identifying areas where $\lambda_i \ge 1$, and the model can predict the distribution under reduced fecundity (e.g. due to an introduced competitor) or survival (e.g. due to an introduced pathogen) (Fig. 2D). 

```{r bbs, echo = FALSE, fig.cap = "Spatial predictions from the fitted DSDM. A) Probability of presence predicted by the DSDM, with 2015 BBS presence (black dots) and absence (ringed white dots) records overlaid. B) Spatial variation in annual fecundity. C) Spatial variation in annual adult survival probability. D) The species' range limits (where the posterior probability $\\lambda_i \\ge 1$ exceeds 0.5) under this baseline model (light blue area), a unilateral 50\\% reduction in fecundity (medium pink area overlaid) or a 25\\% reduction in survival (dark green area overlaid). The predictions in panels B, C and D cannot be made using a correlative SDM.", out.width = "\\textwidth"}
knitr::include_graphics("../figures/bbs_fig.png")
```

Note that this model could undoubtedly be improved by including more information of the species ecology and vital rates &mdash; for example constraining spatial estimates of fecundity and survival to within a range of plausible values &mdash; via prior distributions or changes to model structure. As with any model, the reliability of these vital rate and distribution predictions will depend on the assumptions made and information provided by the modeller. Unlike in purely correlative models however, these assumptions are made clear by explicitly considering spatially-varying vital rates.


# Alternative DSDM specifications

The DSDM structure given in equations 2-3 is simple version for presence-absence data which makes a number of assumptions about the species ecology. This structure can easily be extended to accommodate alternative data types and demographic processes, and answer a range of ecological questions. I detail a number of proposed variants below, and provide full notation and example code in Appendix A.

Whilst statistical inference against distribution data could be performed on almost any demographic model, I restrict the models discussed here to those that are amenable to efficient MCMC methods. Specifically: models with likelihoods that are tractable (the exact value of likelihood can be computed from the parameters and data), and can be differentiated with respect to parameter values. This enables the use of modern gradient-based MCMC samplers [@monnahanFasterEstimationBayesian2017], though it necessarily restricts the scope of these models to those with only continuous parameters. The model variations I propose below encompass a wide range of features whilst remaining within these constraints, and can also make use of efficient vectorised and linear algebra routines, meaning that should scale well to the large datasets commonly used for fitting SDMs.

## Alternative observation models

DSDMs explicitly consider the density of individuals at each location through the relative abundance variable $\Lambda_i$. This provides a link to the most commonly used observations for modelling species distributions in ecology.
An observation model for count data can be specified simply by replacing the Bernoulli sampling distribution in equation 3 with an appropriate count distribution (such as Poisson or negative binomial) and using $\Lambda_i$ as the expectation.
A model for presence-only data can be formed by considering the data as arising from a Poisson point process with $\Lambda_i$ as the intensity at location $i$ [@rennerPointProcessModels2015]. Integration areas for each observation, and a model or prespecified site value for spatial sampling bias can be provided via $\alpha$.
Similarly, where repeat surveys are available, a model for $\alpha$ can be used to estimate the detection probability as in an occupancy-detection analysis [@mackenzieEstimatingSiteOccupancy2002]. 

Since these observation models all relate to $\Lambda_i$, multiple likelihoods could be specified to form an *integrated* DSDM to be fitted to multiple datasets. The integration of multiple liklihoods could enable estimation of parameters such as spatial bias in reporting rates of presence-only data, or to leverage datasets which differ in their spatial and temporal extents or informativeness with respect to growth rates and vital rates.

# Temporal dynamics

The example DSDM given above is temporally static: the covariate values, vital rate parameters, transition matrix and intrinsic growth rate at each site are assumed to be constant through time.
Long-term temporal trends driven by changing environmental covariates can be accommodated in this model simply by considering each time point $t$ as an independent set of observations, such that each set of environmaental conditions $\mathbf{X}_{i,t}$ results in a separate transition matrix $\mathbf{A}_{i,t}$ and corresponds to observed responses $y_{i,t}$. This approach assumes the time periods are sufficiently far apart that the populations have returned to the carrying capacity implied by the contemporary environmental conditions.

With shorter temporal intervals, the impacts of environmental stochasticity on population sizes can be included by explicitly iterating populations through the succession of transition matrices at times $t$:

\begin{align}
\Lambda_{i,t} &= \alpha N_{i,t}  \\ \nonumber
N_{i,t} &= \mathbf{A}_{i,t}N_{i,t-1}
\end{align}

where the new variable $N_{t,i}$ gives the expected population size at time $t$. In this formulation of the DSDM, the initial population at each site $N_{0,i}$ must be provided. This could either be specified as a parameter in the model, via a known initial population size, or as an arbitrary fixed value accompanied by a sufficient 'burn in' period that parameter estimates are not influenced.

# Continuous stages

Can use IPMs too...

The DSDMs I propose are based on transition matrices (including the matrices used in both MPMs and IPMs), which are well studied in ecology and have been used to study a wide range of plant and animal species with very different life histories [@ellnerIntegralProjectionModels].

## Density dependence

Density dependence can be represented in DSDMs by modelling demographic rates as a function of the current population state [@ellnerIntegralProjectionModels] (the abundances of each life stage) as well as covariates.
For example, the current density of individuals could determine fecundity for the next iteration of the dynamics. The matrix iterations will then converge to a stable state; the population carrying capacity or the expected abundance. this can be achieved by iterating populations a sufficient number of times $K$ for the populations to converge on stable population sizes.

\begin{align}
\Lambda_{i} &= \alpha N_{i,K}  \\ \nonumber
N_{i,K} &= \mathbf{A}(N_{i,k-1})N_{i,k-1}
\end{align}


for iteration $k$ in $K$.
 note that this can be combined with Eq 5, or can be iterated for a sufficient number of timesteps ($T$) to get a temporally-static density-dependent model. In practice, $T$ can be determined adaptively, iterating a sufficient number of times for $N_i$ to converge, and then terminating.

## Dispersal

Dispersal can be incorporated in DSDMs by representing an entire metapopulation in a single sparse, block-structured transition matrix, with dispersal represented by transition probabilities between states in different patches [@neubertDEMOGRAPHYDISPERSALCALCULATION2000].

Two approaches (with equation)
- for models using the eigenvalue convolve A with a dispersal matrix D (using a mask for dispersing stages)
- or for density-dependent or temporally dynamic models interleave dispersal and reproduction stages
note that in practice we would compute the eigenvalue by iteration for computational convenience.

Note that the initial populations can be specified in only some patches to represent dispersal limitation. For example in the CaCh example setting zero initial population in the pacific north west - where there is a patch of apparently suitable habitat but where the species does not exist (presumably due to dispersal limitation).

## Biotic interactions 

Biotic interactions between species can be incorporated in a DSDM by representing the interacting dynamics of multiple species in a single transition matrix, with inter-species density dependence [@fujiwaraCoexistenceCompetingStagestructured2011].
By modelling demographic rates of one species as dependent on the abundance of another species, DSDMs can represent the effects of competition, facilitation, predation and parasitism.

add example matrix structure as an equation

# Vital rate regression models

The basic DSDM introduced in the manuscript only considers simple linear models of environmental variables for (appropriately transformed) vital rates. An advantage of specifying these models in a general-purpose statistical modelling software is that these simple models can be replaced with one of any number of statistical models, as appropriate.

For example, these linear models could be applied to very large numbers of covariates and transformations thereof in combination with regularising priors to perform automatic variable selection, similarly to the popular Maxent SDM software[@phillipsModelingSpeciesDistributions2008]. Or to specify mixed-effects models to account for clustered sampling designs, or use random slopes to share environmental reponse information between species in a biotic interaction DSDM. Instead of linear models, non-linear functions could be introduced with generalisd additive models or Gaussian process models, for which there are existing greta extension packages: greta.gam and greta.gp [@goldingGretaGamGeneralised2019; @goldingGretaGpGaussian2019]. These can also be used to model spatial and temporal random effects and account for drivers of species vital rates that are not captured in the measured environmental variables. Prespecified mathematical relationships or covariate values can also be included, enabling incorporation of  spatial and temporal predictions from physiological models.

# Example 2. A DSDM for *Protea repens*

Whilst the model presented in Example 1 makes predictions of spatial variation in vital rates, and provides estimates of uncertainty in those predictions, there is no spatially-varying information on vital rates with which to test those predictions for this species. The time and cost required to robustly estimate how a species' vital rates vary with environmental covariates means that such estimates have been produced for relatively few species; one of the motivations for DSDMs. 


# Discussion


# Prior specification

Basic DSDMs like the model in Example 1 do not require detailed knowledge of a species population dynamics or the relationship between specific demographic rates and the environment in order to make predictions that are comparable to correlative SDMs.
Where such information is available (e.g. from studies or expert opinion) it can be incorporated to improve DSDM predictions either via informative priors or by directly incorporating predictions from other models.

Determining the most common and useful types of prior information, and coming up with straightforward strategies to incorporate them is an area for future research.

The affine transformation provided in example 1 is one approach. An integrated likelihood is another option - the analysis of recapture data to inform vital rates at specific sites could be performed simultaneously with estimation of the DSDM...



## Parameter identifiability

Like many ecologically-realistic models, DSDM parameters are in general not uniquely identified, so estimates may be correlated or even multimodal.
This non-identifiability is ecologically informative as it arises from ignorance of the species’ ecology and highlights areas where more research is needed.
This ignorance can be captured in prediction uncertainty, more realistically representing how well we can predict distributions [@bealeIncorporatingUncertaintyPredictive2012].

Example 1 indicates that identifiability issues do not affect predictions of the probability of presence, even if the data and priors do not provide sufficient information to disentangle vital rates.
This example also suggests that a minimal amount of information is required to make the vital rates identifiable.
These issues of identifiability warrant more detailed investigation, and healthy scepticism on the part of users.
However since identifiability will depend on the nature of the data, model, and prior information, a detailed assessment of model identifiability is beyond the scope of this manuscript.

However, poor identification complicates statistical inference as maximum likelihood methods will be inaccurate and Markov chain Monte Carlo samplers may not converge [@monnahanFasterEstimationBayesian2017].
This proposal uses two new tools to resolve this issue and fit DSDMs to large datasets: Hamiltonian Monte Carlo & high performance automatic differentiation.



report posterior correlations for the BBS model

##  Computation

Hamiltonian Monte Carlo (HMC) is a Markov chain Monte Carlo method that can sample effectively from highly correlated and multi-modal parameter distributions [@monnahanFasterEstimationBayesian2017], but requires gradient calculations.
Automatic differentiation (AD, also known as back-propagation) is a computational technique to derive these gradients. Whilst HMC & AD modelling software is available [@carpenterStanProbabilisticProgramming2017], it is not optimised for the large-scale linear algebra required for DSDMs.
High-performance AD software enables complex machine learning models (e.g. deep neural networks) to be fit to very large datasets; facilitating recent dramatic advances in artificial intelligence.
Google’s recently released open source, high performance AD software TensorFlow is optimised for massive linear algebra [@abadiTensorFlowLargeScaleMachine2016].
I have combined HMC with TensorFlow in an R package greta [@goldingGretaSimpleScalable2019] for flexible specification of and sampling from statistical models in R.
Using greta, ecologists can easily build and fit DSDMs on desktop computers or high-performance compute clusters.


Include an appendix with notation and greta code for all of the model variants described above


Bayesian inference on the DSDM for the Carolina Chickadee by MCMC took `r round(bbs_time)` seconds on a laptop computer. For this particular model, the computation time can be sped up by using an analytic solution to the transition matrix eigenvalues: $\lambda_i = F_i S_{J_i} + S_{A_i}$.
Fitting the analytic version of the model with the same Bayesian inference routine took `r round(bbs_analytic_time)` seconds on the same machine.
Such convenient and computationally efficient analytic solutions will not be available for all DSDM models, however,particularly where matrices are large or encode more complex demography, such as trait-dependent or temporally stochastic vital rates, density dependence, or dispersal. Moreover, deriving analytic solutions for quantities relating to matrix population models is likely to be outside the skill-set of most ecologists, and in any case would force users to focus on model implementation details rather than the ecology of their study species. Consequently, the ability to efficiently analyse large numbers of population transition matrices during each iteration of the inference algorithm is critical to ensuring DSDMs are a practically useful tool for ecologists.

The greta extension package greta.dynamics provides methods for efficiently analysing multiple population transition matrices to determine their intrinsic growth rates and stable stage distributions. The package also enables efficient analysis of dynamic transition matrices, where vital rates and therefore the matrix at each iteration depend on the previous population size or temporally-varying covariates,enabling modelling of density-dependent or temporally stochastic demographics in DSDMs. Whilst dispersal can already be implemented by convolving population transition matrices with a dispersal matrix, future versions of the R package will facilitate more computationally efficient algorithms for accounting for dispersal, leveraging the inherent sparsity in dispersal matrices.

### Supporting information

The code required to reproduce this manuscript is archived at [<code to be archived on acceptance>](), and hosted at [<github link>]().

### Author's contributions

NG developed the model, software and example analyses and wrote the manuscript.

### Acknowledgements

This work was funded by a McKenzie fellowship from the University of Melbourne and an ARC DECRA fellowship (DE180100635).

### Data accessibility

Carolina Chickadee data were downloaded from the North American Breeding Bird Survey FTP site. Protea data are made available as an appendix to @merowUsingIntegralProjection2014, they can be downloaded by searching for artefact ECOG-00839 at [http://www.ecography.org/readers/appendix]()

### Figures

[To be moved here later]

### References
